## ADDED Requirements

### Requirement: 多模态搜索输入
系统SHALL支持文本、语音、图像三种搜索输入方式，并能够将不同模态的输入转换为统一的查询表示。

#### Scenario: 文本搜索输入
- **WHEN** 用户在搜索框输入文本查询 "上周的产品设计PPT"
- **THEN** 系统接收文本并进行语义理解
- **AND** 提取关键词 "产品设计"、"PPT" 和时间范围 "上周"

#### Scenario: 语音搜索输入
- **WHEN** 用户点击语音按钮并说出查询内容
- **THEN** 系统录制音频（最长30秒）
- **AND** 使用Whisper模型将语音转换为文本
- **AND** 将转换后的文本作为查询输入

#### Scenario: 图片搜索输入
- **WHEN** 用户上传图片进行搜索
- **THEN** 系统接收图片并使用Chinese-CLIP生成特征向量
- **AND** 在向量索引中搜索相似的图片
- **AND** 返回视觉相似的文件结果

### Requirement: AI查询理解
系统SHALL使用AI模型理解用户查询意图，提取关键词、时间范围、文件类型等信息，生成语义化的查询表示。

#### Scenario: 时间范围识别
- **WHEN** 用户查询包含 "最近三天"、"上周"、"这个月" 等时间表达
- **THEN** 系统识别并转换为具体日期范围
- **AND** 自动添加时间过滤器

#### Scenario: 文件类型识别
- **WHEN** 用户查询包含 "PPT"、"图片"、"文档" 等文件类型词
- **THEN** 系统识别对应的文件扩展名
- **AND** 自动添加文件类型过滤器

#### Scenario: 语义查询扩展
- **WHEN** 用户输入 "重要文档"
- **THEN** LLM分析语义并生成同义词扩展
- **AND** 生成查询向量用于语义搜索

### Requirement: 混合搜索召回
系统SHALL同时执行向量搜索和全文搜索，并使用RRF算法融合多路召回结果。

#### Scenario: 向量检索执行
- **WHEN** 接收到查询向量
- **THEN** 使用Faiss进行余弦相似度搜索
- **AND** 返回Top-50个最相似的文档
- **AND** 记录每个文档的向量相似度分数

#### Scenario: 全文检索执行
- **WHEN** 接收到关键词查询
- **THEN** 使用Whoosh执行BM25算法搜索
- **AND** 返回Top-50个匹配文档
- **AND** 记录每个文档的BM25分数

#### Scenario: 结果融合排序
- **WHEN** 获得向量和全文搜索结果
- **THEN** 使用RRF算法融合结果：score = 0.6/(40+vector_rank) + 0.4/(40+text_rank)
- **AND** 按融合分数降序排列
- **AND** 返回Top-20结果给用户

### Requirement: 搜索结果处理
系统SHALL对搜索结果进行后处理，包括关键词高亮、摘要生成、匹配度计算等。

#### Scenario: 关键词高亮
- **WHEN** 返回搜索结果给用户
- **THEN** 在内容预览中高亮匹配的关键词
- **AND** 使用HTML <mark> 标签标记匹配文本
- **AND** 提取匹配关键词周围的上下文（前后各50字符）

#### Scenario: 结果摘要生成
- **WHEN** 搜索结果包含长文本内容
- **THEN** 提取包含匹配关键词的文本片段
- **AND** 生成简洁的内容摘要（最多200字符）
- **AND** 突出显示与查询相关的部分

#### Scenario: 匹配度评分
- **WHEN** 计算搜索结果的相关性
- **THEN** 综合向量相似度、文本匹配度、文件类型等因素
- **AND** 生成0-1的相关性分数
- **AND** 按相关性分数排序结果

### Requirement: 搜索过滤和排序
系统SHALL支持多种过滤条件和排序方式，让用户能够精确定位所需文件。

#### Scenario: 文件类型过滤
- **WHEN** 用户选择只搜索文档类型
- **THEN** 只返回content_type为document的文件
- **AND** 支持PDF、Word、Excel、PPT等具体类型

#### Scenario: 时间范围过滤
- **WHEN** 用户设置时间过滤器为"最近一周"
- **THEN** 只返回file_modified_at在最近7天内的文件
- **AND** 支持自定义日期范围选择

#### Scenario: 目录范围过滤
- **WHEN** 用户选择在特定目录中搜索
- **THEN** 只返回该目录及其子目录中的文件
- **AND** 支持多目录选择

#### Scenario: 多种排序方式
- **WHEN** 用户选择按时间排序
- **THEN** 按文件修改时间降序排列结果
- **AND** 支持相关性、文件名、文件大小等排序选项

### Requirement: 搜索性能优化
系统SHALL通过各种优化策略确保搜索性能满足要求，搜索响应时间小于1秒。

#### Scenario: 查询缓存
- **WHEN** 用户重复执行相同的查询
- **THEN** 系统检查缓存是否存在该查询结果
- **AND** 如果缓存命中且未过期，直接返回缓存结果
- **AND** 缓存有效期设为5分钟

#### Scenario: 并行召回
- **WHEN** 执行搜索查询
- **THEN** 同时启动向量搜索和全文搜索
- **AND** 使用asyncio并发执行
- **AND** 等待两个搜索完成后进行结果融合

#### Scenario: 索引预热
- **WHEN** 系统启动时
- **THEN** 预加载AI模型到内存
- **AND** 预热向量索引和全文索引
- **AND** 确保首次搜索也能快速响应