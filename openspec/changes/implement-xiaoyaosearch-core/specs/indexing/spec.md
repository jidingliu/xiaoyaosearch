## ADDED Requirements

### Requirement: 目录扫描和监控
系统SHALL能够扫描用户指定的目录，递归发现所有支持文件类型的文件，并监控文件变化。

#### Scenario: 目录添加和验证
- **WHEN** 用户添加新的索引目录
- **THEN** 验证目录是否存在且可读
- **AND** 检查目录是否已添加到索引列表
- **AND** 开始递归扫描目录结构

#### Scenario: 递归文件扫描
- **WHEN** 扫描目录结构时
- **THEN** 遍历所有子目录
- **AND** 跳过隐藏文件（以.开头的文件）
- **AND** 根据排除模式过滤文件（如node_modules、.git等）
- **AND** 只处理支持文件扩展名的文件

#### Scenario: 文件变更监控
- **WHEN** 监控的目录中文件发生变化
- **THEN** 使用watchdog库监控文件系统事件
- **AND** 检测文件创建、修改、删除、移动事件
- **AND** 将变更事件加入索引更新队列

### Requirement: 文件内容提取
系统SHALL能够从多种文件格式中提取文本内容和元数据，支持文档、图片、音频、视频等文件类型。

#### Scenario: 文档类文件处理
- **WHEN** 处理PDF文件
- **THEN** 使用Marker库提取文本内容
- **AND** 提取文档元数据（标题、作者、页数等）
- **AND** 生成内容预览和摘要

- **WHEN** 处理Office文档（Word、Excel、PPT）
- **THEN** 使用LibreOffice转换为PDF
- **AND** 使用Marker从PDF提取文本
- **AND** 保留原始文档格式信息

- **WHEN** 处理纯文本文件（TXT、Markdown）
- **THEN** 直接读取文件内容
- **AND** 清理格式字符和特殊符号
- **AND** 识别文档结构（标题、段落等）

#### Scenario: 图片类文件处理
- **WHEN** 处理图片文件（JPG、PNG等）
- **THEN** 使用PaddleOCR提取图片中的文字
- **AND** 使用Chinese-CLIP生成图片标签
- **AND** 提取EXIF元数据（拍摄时间、地点等）
- **AND** 生成图片缩略图

#### Scenario: 音频类文件处理
- **WHEN** 处理音频文件（MP3、WAV等）
- **THEN** 使用FFmpeg转换为16kHz单声道WAV格式
- **AND** 使用FastWhisper进行语音转文字
- **AND** 提取音频元数据（时长、比特率等）
- **AND** 生成带时间戳的转录文本

#### Scenario: 视频类文件处理
- **WHEN** 处理视频文件（MP4、AVI等）
- **THEN** 使用FFmpeg提取音频轨道
- **AND** 对音频进行语音转文字转录
- **AND** 提取关键帧（默认15帧）
- **AND** 对关键帧进行图像分析和标签生成

### Requirement: 文本处理和向量化
系统SHALL对提取的文本内容进行预处理、分块、向量化等操作，为搜索做好准备。

#### Scenario: 文本预处理
- **WHEN** 获得原始文本内容
- **THEN** 清理HTML标签和特殊字符
- **AND** 进行中文分词处理
- **AND** 移除停用词和无意义字符
- **AND** 统一文本编码为UTF-8

#### Scenario: 文本分块策略
- **WHEN** 处理长文本内容
- **THEN** 按语义段落进行分块
- **AND** 每个文本块大小约为512个字符
- **AND** 块之间重叠100个字符
- **AND** 每个文件最多分成100个块

#### Scenario: 文本向量化
- **WHEN** 处理文本块
- **THEN** 使用BGE模型生成768维向量
- **AND** 对向量进行L2归一化
- **AND** 批量处理提高效率（batch_size=32）
- **AND** 缓存向量结果避免重复计算

### Requirement: 索引构建和更新
系统SHALL构建和维护向量索引、全文索引和数据库索引，支持高效的搜索查询。

#### Scenario: 向量索引构建
- **WHEN** 处理文件向量数据
- **THEN** 使用Faiss构建IVFFlat索引
- **THEN** 设置nlist=100个聚类中心
- **AND** 存储向量ID到文件ID的映射关系
- **AND** 支持增量添加和删除向量

#### Scenario: 全文索引构建
- **WHEN** 处理文件文本内容
- **THEN** 使用Whoosh构建全文索引
- **AND** 配置中文分词器
- **AND** 索引文件名、内容、元数据等字段
- **AND** 支持BM25相关性评分

#### Scenario: 数据库索引构建
- **WHEN** 存储文件元数据
- **THEN** 在SQLite数据库中创建索引
- **AND** 为文件路径、文件名、修改时间等字段创建索引
- **AND** 支持高效的过滤和排序查询

### Requirement: 增量索引更新
系统SHALL监控文件变化，实时更新索引，确保搜索结果的准确性。

#### Scenario: 变更事件去抖
- **WHEN** 检测到文件系统事件
- **THEN** 对同一文件的变化进行5秒内的去抖处理
- **AND** 避免频繁触发索引更新
- **AND** 批量处理多个变更事件

#### Scenario: 文件变更处理
- **WHEN** 检测到文件创建
- **THEN** 将文件添加到索引处理队列
- **AND** 提取内容并创建索引

- **WHEN** 检测到文件修改
- **THEN** 删除旧索引数据
- **AND** 重新提取内容并创建新索引

- **WHEN** 检测到文件删除
- **THEN** 从所有索引中移除文件
- **AND** 清理相关的缓存数据

### Requirement: 索引性能优化
系统SHALL通过各种策略优化索引性能，确保在合理时间内完成大量文件的索引工作。

#### Scenario: 并发处理
- **WHEN** 处理大量文件
- **THEN** 使用多线程并发处理文件
- **AND** 限制最大并发数为4
- **AND** 使用信号量控制资源使用

#### Scenario: 批量操作
- **WHEN** 更新索引数据
- **THEN** 批量插入数据库记录
- **AND** 批量添加向量到索引
- **AND** 批量更新全文索引

#### Scenario: 内存管理
- **WHEN** 处理大文件
- **THEN** 流式读取文件内容
- **AND** 及时释放不需要的内存
- **AND** 监控内存使用情况

#### Scenario: 错误处理
- **WHEN** 文件处理失败
- **THEN** 记录错误日志
- **AND** 跳过问题文件继续处理其他文件
- **AND** 提供重试机制处理临时错误

### Requirement: 索引统计和监控
系统SHALL提供索引统计信息和运行状态监控，帮助用户了解索引进度和系统健康状况。

#### Scenario: 索引进度跟踪
- **WHEN** 执行索引任务时
- **THEN** 实时更新处理进度
- **AND** 显示当前正在处理的文件
- **AND** 估算剩余处理时间

#### Scenario: 统计信息收集
- **WHEN** 索引完成后
- **THEN** 统计已索引文件数量
- **AND** 计算索引总大小
- **AND** 按文件类型统计分布情况

#### Scenario: 系统状态监控
- **WHEN** 系统运行时
- **THEN** 监控CPU和内存使用情况
- **AND** 检测磁盘空间使用
- **AND** 报告系统健康状况