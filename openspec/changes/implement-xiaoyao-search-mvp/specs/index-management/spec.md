# 文件索引管理模块规格

## ADDED Requirements

### 目录管理
#### Requirement: 扫描目录配置
- **系统**必须允许用户添加和删除要索引的目录
- **优先级**: P0
- **验收标准**: 支持添加多个目录，验证目录存在性和权限

#### Scenario: 添加扫描目录
- **Given** 用户选择要索引的文件夹路径
- **When** 用户添加该目录
- **Then** 系统验证目录存在性和读取权限，成功添加到扫描列表

#### Scenario: 移除扫描目录
- **Given** 用户从列表中选择已添加的目录
- **When** 用户移除该目录
- **Then** 系统从扫描列表中移除该目录，并清理相关索引数据

#### Requirement: 目录状态显示
- **系统**必须显示每个目录的索引状态和统计信息
- **优先级**: P0
- **验收标准**: 显示已索引文件数、索引状态、最后扫描时间

#### Scenario: 目录状态查看
- **Given** 用户查看目录管理页面
- **When** 页面加载完成
- **Then** 显示所有已添加目录的状态，包括文件数量和索引进度

### 文件扫描
#### Requirement: 递归目录扫描
- **系统**必须能够递归扫描指定目录下的所有文件
- **优先级**: P0
- **验收标准**: 支持多层级目录遍历，正确处理文件和子目录

#### Scenario: 全量目录扫描
- **Given** 用户添加新的扫描目录
- **When** 系统开始扫描
- **Then** 递归扫描该目录下的所有文件，识别支持的文件类型

#### Requirement: 增量文件扫描
- **系统**必须支持增量扫描，仅处理新增或修改的文件
- **优先级**: P0
- **验收标准**: 通过文件哈希检测文件变化，跳过未修改文件

#### Scenario: 增量扫描执行
- **Given** 用户重新扫描已索引目录
- **When** 系统执行扫描
- **Then** 仅处理新增、修改或删除的文件，跳过未变化文件

#### Requirement: 文件过滤规则
- **系统**必须支持文件过滤，跳过不需要索引的文件
- **优先级**: P0
- **验收标准**: 跳过隐藏文件、系统文件、超出大小限制的文件

#### Scenario: 文件过滤应用
- **Given** 系统扫描目录时遇到.git文件夹
- **When** 处理文件过滤
- **Then** 自动跳过.git文件夹及其内容

### 文件监控
#### Requirement: 实时文件监控
- **系统**必须监控文件系统变化，实时更新索引
- **优先级**: P0
- **验收标准**: 监控文件创建、修改、删除、移动操作

#### Scenario: 文件创建监控
- **Given** 用户在监控目录中创建新文件
- **When** 文件系统事件触发
- **Then** 系统自动检测并开始索引新文件

#### Scenario: 文件修改监控
- **Given** 用户修改已索引文件的内容
- **When** 文件系统事件触发
- **Then** 系统重新提取内容并更新索引

#### Requirement: 监控事件去抖
- **系统**必须对文件监控事件进行去抖处理
- **优先级**: P1
- **验收标准**: 同一文件5秒内多次变化只处理一次

#### Scenario: 事件去抖处理
- **Given** 文件在短时间内被多次修改
- **When** 系统接收监控事件
- **Then** 合并事件，避免重复索引操作

### 文件内容提取
#### Requirement: 多格式文件内容提取
- **系统**必须支持多种文件格式的内容提取
- **优先级**: P0
- **验收标准**: 支持PDF、Word、Excel、PPT、TXT、Markdown格式

#### Scenario: PDF文档内容提取
- **Given** 系统需要索引PDF文件
- **When** 执行内容提取
- **Then** 使用Marker库将PDF转换为文本，提取完整内容

#### Scenario: Office文档内容提取
- **Given** 系统需要索引Word/Excel/PPT文件
- **When** 执行内容提取
- **Then** 通过LibreOffice转换为PDF，再提取文本内容

#### Requirement: 文本文件直接读取
- **系统**必须支持纯文本文件的直接内容读取
- **优先级**: P0
- **验收标准**: 正确读取TXT、Markdown等文本格式文件

#### Scenario: 文本文件处理
- **Given** 系统遇到.md文件
- **When** 执行内容提取
- **Then** 直接读取文件内容，保留文本格式

### 索引构建
#### Requirement: 多模态索引构建
- **系统**必须为每个文件构建向量和全文索引
- **优先级**: P0
- **验收标准**: 使用BGE模型生成向量，Whoosh构建全文索引

#### Scenario: 向量索引构建
- **Given** 文件内容已提取
- **When** 构建向量索引
- **Then** 使用BGE模型生成768维向量，存储到Faiss索引

#### Scenario: 全文索引构建
- **Given** 文件内容已提取
- **When** 构建全文索引
- **Then** 使用Whoosh为文件内容创建BM25索引

#### Requirement: 元数据索引
- **系统**必须索引文件元数据信息
- **优先级**: P0
- **验收标准**: 存储文件路径、大小、修改时间、文件类型等元数据

#### Scenario: 元数据存储
- **Given** 文件处理完成
- **When** 存储元数据
- **Then** 将文件信息保存到SQLite数据库

### 索引维护
#### Requirement: 索引状态管理
- **系统**必须维护索引的完整性状态
- **优先级**: P0
- **验收标准**: 检测索引损坏，支持索引重建

#### Scenario: 索引损坏检测
- **Given** 系统启动时检查索引
- **When** 发现索引文件损坏
- **Then** 标记索引需要重建，通知用户

#### Requirement: 索引优化
- **系统**必须定期优化索引结构
- **优先级**: P1
- **验收标准**: 压缩索引文件，优化查询性能

#### Scenario: 索引优化执行
- **Given** 系统空闲时间
- **When** 执行索引优化
- **Then** 重建Faiss索引结构，压缩Whoosh索引

### 性能与并发控制
#### Requirement: 批量文件处理
- **系统**必须支持批量文件处理以提高效率
- **优先级**: P0
- **验收标准**: 每批处理10个文件，支持并行处理

#### Scenario: 批量索引处理
- **Given** 有大量文件需要索引
- **When** 系统开始处理
- **Then** 将文件分批处理，每批10个，避免内存溢出

#### Requirement: 并发控制
- **系统**必须控制并发处理数量
- **优先级**: P1
- **验收标准**: 最大并发数4，避免系统过载

#### Scenario: 并发限制应用
- **Given** 系统同时处理多个文件
- **When** 达到并发限制
- **Then** 使用信号量控制，等待空闲处理槽位

### 错误处理与恢复
#### Requirement: 文件处理错误处理
- **系统**必须优雅处理文件处理过程中的错误
- **优先级**: P0
- **验收标准**: 记录错误信息，跳过问题文件，继续处理其他文件

#### Scenario: 文件访问错误
- **Given** 系统尝试处理无权限访问的文件
- **When** 遇到权限错误
- **Then** 记录错误日志，跳过该文件，继续处理其他文件

#### Requirement: 索引恢复机制
- **系统**必须支持从异常中恢复索引状态
- **优先级**: P1
- **验收标准**: 系统崩溃后能够恢复索引一致性

#### Scenario: 索引恢复
- **Given** 系统异常关闭后重启
- **When** 检查索引状态
- **Then** 识别未完成的索引操作，恢复或清理不一致状态

### 进度与状态通知
#### Requirement: 索引进度显示
- **系统**必须显示文件索引的实时进度
- **优先级**: P0
- **验收标准**: 显示进度条、当前处理文件、已处理文件数量

#### Scenario: 进度显示更新
- **Given** 用户查看索引页面
- **When** 索引进行中
- **Then** 实时更新进度信息，包括百分比和剩余时间估算

#### Requirement: 状态变化通知
- **系统**必须通过WebSocket通知前端索引状态变化
- **优先级**: P1
- **验收标准**: 索引开始、进行中、完成时发送通知

#### Scenario: 状态通知
- **Given** 索引完成
- **When** 状态发生变化
- **Then** 通过WebSocket向前端发送完成通知