# å°é¥æœç´¢ XiaoyaoSearch - æ•°æ®åº“è®¾è®¡æ–‡æ¡£

## 1. æ¦‚è¿°

### 1.1 æ•°æ®åº“æ¶æ„
å°é¥æœç´¢é‡‡ç”¨**å¤šå­˜å‚¨å¼•æ“æ··åˆæ¶æ„**ï¼š

| å­˜å‚¨å¼•æ“ | ç”¨é€” | ä¼˜åŠ¿ | æ–‡ä»¶ä½ç½® |
|---------|------|------|----------|
| **SQLite** | ä¸»æ•°æ®åº“ï¼Œå­˜å‚¨å…ƒæ•°æ® | ACIDäº‹åŠ¡ã€è½»é‡çº§ã€æ— éœ€æœåŠ¡å™¨ | `data/database/xiaoyao_search.db` |
| **Faiss** | å‘é‡ç´¢å¼•ï¼Œè¯­ä¹‰æœç´¢ | é«˜æ•ˆå‘é‡ç›¸ä¼¼åº¦æ£€ç´¢ | `data/indexes/faiss/` |
| **Whoosh** | å…¨æ–‡ç´¢å¼•ï¼Œæ–‡æœ¬æœç´¢ | ä¸­æ–‡åˆ†è¯ã€æ¨¡ç³Šæœç´¢ | `data/indexes/whoosh/` |

## 2. å­˜å‚¨å¼•æ“è®¾è®¡

### 2.1 SQLite å…³ç³»æ•°æ®åº“è®¾è®¡

#### 2.1.1 æ•°æ®åº“ERå›¾

```mermaid
erDiagram
    %% æ ¸å¿ƒè¡¨å®šä¹‰
    files {
        INTEGER id PK "ä¸»é”®ï¼Œå”¯ä¸€æ ‡è¯†æ–‡ä»¶"
        TEXT file_path UK "æ–‡ä»¶ç»å¯¹è·¯å¾„ï¼Œç”¨äºå»é‡å’Œå®šä½"
        TEXT file_name "æ–‡ä»¶åï¼ˆå«æ‰©å±•åï¼‰"
        TEXT file_extension "æ–‡ä»¶æ‰©å±•åï¼ˆå¦‚.pdfã€.mp3ï¼‰"
        TEXT file_type "æ–‡ä»¶ç±»å‹ï¼švideo/audio/document/image"
        INTEGER file_size "æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰"
        DATETIME created_at "æ–‡ä»¶åˆ›å»ºæ—¶é—´"
        DATETIME modified_at "æ–‡ä»¶æœ€åä¿®æ”¹æ—¶é—´"
        DATETIME indexed_at "ç´¢å¼•å»ºç«‹æ—¶é—´"
        TEXT content_hash "æ–‡ä»¶å†…å®¹SHA256å“ˆå¸Œï¼Œç”¨äºå˜æ›´æ£€æµ‹"

        %% ç´¢å¼•ç›¸å…³å­—æ®µ
        INTEGER faiss_index_id "å…³è”Faisså‘é‡ç´¢å¼•ID"
        TEXT whoosh_doc_id "å…³è”Whooshæ–‡æ¡£ID"
        BOOLEAN is_indexed "æ˜¯å¦å·²ç´¢å¼•"
        BOOLEAN is_content_parsed "æ˜¯å¦å·²è§£æå†…å®¹"
        TEXT index_status "ç´¢å¼•çŠ¶æ€ï¼špending/processing/completed/failed"

        %% æ‰©å±•å…ƒæ•°æ®å­—æ®µ
        TEXT mime_type "MIMEç±»å‹"
        TEXT title "æ–‡æ¡£æ ‡é¢˜"
        TEXT author "ä½œè€…"
        TEXT keywords "å…³é”®è¯ï¼Œé€—å·åˆ†éš”"

        %% å†…å®¹ç»Ÿè®¡å­—æ®µ
        INTEGER content_length "å†…å®¹é•¿åº¦ï¼ˆå­—ç¬¦æ•°ï¼‰"
        INTEGER word_count "è¯æ±‡æ•°é‡"

        %% å¤„ç†è´¨é‡è¯„ä¼°å­—æ®µ
        REAL parse_confidence "è§£æç½®ä¿¡åº¦(0-1)"
        REAL index_quality_score "ç´¢å¼•è´¨é‡è¯„åˆ†(0-1)"

        %% é”™è¯¯å¤„ç†å­—æ®µ
        TEXT last_error "æœ€åé”™è¯¯ä¿¡æ¯"
        INTEGER retry_count "é‡è¯•æ¬¡æ•°"

        %% ç‰ˆæœ¬æ§åˆ¶å­—æ®µ
        TEXT index_version "ç´¢å¼•ç‰ˆæœ¬"
        BOOLEAN needs_reindex "æ˜¯å¦éœ€è¦é‡æ–°ç´¢å¼•"

        %% åˆ†å—æ”¯æŒå­—æ®µ (v2.0æ–°å¢)
        BOOLEAN is_chunked "æ˜¯å¦å·²åˆ†å—å¤„ç†"
        INTEGER total_chunks "æ€»åˆ†å—æ•°é‡"
        TEXT chunk_strategy "åˆ†å—ç­–ç•¥(å¦‚500+50)"
        INTEGER avg_chunk_size "å¹³å‡åˆ†å—å¤§å°"
    }

    file_chunks {
        INTEGER id PK "ä¸»é”®ï¼Œå”¯ä¸€æ ‡è¯†åˆ†å—"
        INTEGER file_id FK "å…³è”çš„æ–‡ä»¶ID"
        INTEGER chunk_index "åˆ†å—åºå·(ä»0å¼€å§‹)"
        TEXT content "åˆ†å—æ–‡æœ¬å†…å®¹"
        INTEGER content_length "åˆ†å—å†…å®¹é•¿åº¦"
        INTEGER start_position "åœ¨åŸæ–‡ä¸­çš„èµ·å§‹ä½ç½®"
        INTEGER end_position "åœ¨åŸæ–‡ä¸­çš„ç»“æŸä½ç½®"

        %% ç´¢å¼•å…³è”å­—æ®µ
        INTEGER faiss_index_id "å…³è”Faisså‘é‡ç´¢å¼•ID"
        TEXT whoosh_doc_id "å…³è”Whooshæ–‡æ¡£ID"

        %% å¤„ç†çŠ¶æ€å­—æ®µ
        BOOLEAN is_indexed "æ˜¯å¦å·²ç´¢å¼•"
        TEXT index_status "åˆ†å—ç´¢å¼•çŠ¶æ€"

        %% è´¨é‡è¯„ä¼°å­—æ®µ
        REAL embedding_quality "å‘é‡è´¨é‡è¯„åˆ†"

        %% æ—¶é—´æˆ³å­—æ®µ
        DATETIME created_at "åˆ›å»ºæ—¶é—´"
        DATETIME indexed_at "ç´¢å¼•æ—¶é—´"
    }

    search_history {
        INTEGER id PK "ä¸»é”®ï¼Œå”¯ä¸€æ ‡è¯†æœç´¢è®°å½•"
        TEXT search_query "ç”¨æˆ·æœç´¢æŸ¥è¯¢å†…å®¹"
        TEXT input_type "è¾“å…¥ç±»å‹ï¼štext/voice/image"
        TEXT search_type "æœç´¢ç±»å‹ï¼šsemantic/fulltext/hybrid"
        TEXT ai_model_used "ä½¿ç”¨çš„AIæ¨¡å‹åç§°"
        INTEGER result_count "æœç´¢ç»“æœæ•°é‡"
        REAL response_time "å“åº”æ—¶é—´ï¼ˆç§’ï¼‰"
        DATETIME created_at "æœç´¢æ—¶é—´"
    }

    ai_models {
        INTEGER id PK "ä¸»é”®ï¼Œå”¯ä¸€æ ‡è¯†æ¨¡å‹é…ç½®"
        TEXT model_type "æ¨¡å‹ç±»å‹ï¼šembedding/speech/vision/llm"
        TEXT provider "æä¾›å•†ç±»å‹ï¼šlocal/cloud"
        TEXT model_name "æ¨¡å‹åç§°ï¼ˆå¦‚BGE-M3ã€faster-whisperï¼‰"
        TEXT config_json "JSONæ ¼å¼çš„æ¨¡å‹é…ç½®å‚æ•°"
        BOOLEAN is_active "æ˜¯å¦å¯ç”¨è¯¥æ¨¡å‹"
        DATETIME created_at "é…ç½®åˆ›å»ºæ—¶é—´"
        DATETIME updated_at "é…ç½®æ›´æ–°æ—¶é—´"
    }

    index_jobs {
        INTEGER id PK "ä¸»é”®ï¼Œå”¯ä¸€æ ‡è¯†ç´¢å¼•ä»»åŠ¡"
        TEXT folder_path "ç´¢å¼•ç›®æ ‡æ–‡ä»¶å¤¹è·¯å¾„"
        TEXT job_type "ä»»åŠ¡ç±»å‹ï¼šcreate/update/rebuild/delete"
        TEXT status "ä»»åŠ¡çŠ¶æ€ï¼špending/processing/completed/failed"
        INTEGER total_files "æ€»æ–‡ä»¶æ•°"
        INTEGER processed_files "å·²å¤„ç†æ–‡ä»¶æ•°"
        INTEGER error_count "å¤„ç†å¤±è´¥æ–‡ä»¶æ•°"
        DATETIME started_at "ä»»åŠ¡å¼€å§‹æ—¶é—´"
        DATETIME completed_at "ä»»åŠ¡å®Œæˆæ—¶é—´"
        TEXT error_message "é”™è¯¯ä¿¡æ¯"
    }

    file_content {
        INTEGER id PK "ä¸»é”®ï¼Œå”¯ä¸€æ ‡è¯†å†…å®¹è®°å½•"
        INTEGER file_id FK "å…³è”çš„æ–‡ä»¶ID"
        TEXT title "æå–çš„æ ‡é¢˜"
        TEXT content "è§£æçš„æ–‡æœ¬å†…å®¹"
        INTEGER content_length "å†…å®¹é•¿åº¦ï¼ˆå­—ç¬¦æ•°ï¼‰"
        INTEGER word_count "è¯æ±‡æ•°é‡"
        TEXT language "æ£€æµ‹åˆ°çš„è¯­è¨€(zh/en/unknown)"
        TEXT encoding "æ–‡ä»¶ç¼–ç "
        REAL confidence "å†…å®¹è§£æç½®ä¿¡åº¦(0-1)"
        TEXT parse_method "è§£ææ–¹æ³•"
        BOOLEAN is_parsed "æ˜¯å¦å·²è§£æ"
        BOOLEAN has_error "æ˜¯å¦æœ‰è§£æé”™è¯¯"
        TEXT error_message "è§£æé”™è¯¯ä¿¡æ¯"
        DATETIME parsed_at "è§£ææ—¶é—´"
        DATETIME updated_at "æ›´æ–°æ—¶é—´"
    }

    app_settings {
        INTEGER id PK "ä¸»é”®"
        TEXT setting_key UK "è®¾ç½®é”®å"
        TEXT setting_value "è®¾ç½®å€¼"
        TEXT setting_type "å€¼ç±»å‹ï¼šstring/integer/boolean/json"
        TEXT description "è®¾ç½®è¯´æ˜"
        DATETIME updated_at "è®¾ç½®æ›´æ–°æ—¶é—´"
    }

    %% å…³ç³»å®šä¹‰
    files ||--|| file_content : "ä¸€ä¸ªæ–‡ä»¶å¯¹åº”ä¸€ä¸ªå†…å®¹è®°å½•"
    files ||--o{ file_chunks : "ä¸€ä¸ªæ–‡ä»¶å¯¹åº”å¤šä¸ªåˆ†å—"
    files ||--o{ search_history : "æ–‡ä»¶æœç´¢ä¼šäº§ç”Ÿå†å²è®°å½•"
    ai_models ||--o{ search_history : "AIæ¨¡å‹ä½¿ç”¨è®°å½•"

    %% ç´¢å¼•è¯´æ˜
    %% filesè¡¨ç´¢å¼•ï¼š
    %% PRIMARY KEY (id)
    %% UNIQUE KEY (file_path)
    %% INDEX (file_name)
    %% INDEX (file_type)
    %% INDEX (file_extension)
    %% INDEX (created_at)
    %% INDEX (modified_at)
    %% INDEX (indexed_at)
    %% INDEX (content_hash)
    %% INDEX (faiss_index_id)
    %% INDEX (whoosh_doc_id)
    %% INDEX (is_indexed)
    %% INDEX (index_status)
    %% INDEX (is_content_parsed)
    %% INDEX (needs_reindex)
    %% INDEX (parse_confidence)
    %% INDEX (index_quality_score)
    %% INDEX (is_chunked) "v2.0æ–°å¢"
    %% INDEX (total_chunks) "v2.0æ–°å¢"

    %% file_chunksè¡¨ç´¢å¼• (v2.0æ–°å¢):
    %% PRIMARY KEY (id)
    %% UNIQUE KEY (file_id, chunk_index)
    %% INDEX (file_id)
    %% INDEX (faiss_index_id)
    %% INDEX (is_indexed)
    %% INDEX (created_at)

    %% file_contentè¡¨ç´¢å¼•ï¼š
    %% PRIMARY KEY (id)
    %% UNIQUE KEY (file_id)
    %% INDEX (language)
    %% INDEX (is_parsed)
    %% INDEX (has_error)
    %% INDEX (parsed_at)
    %% INDEX (updated_at)

    %% search_historyè¡¨ç´¢å¼•ï¼š
    %% PRIMARY KEY (id)
    %% INDEX (search_query)
    %% INDEX (input_type)
    %% INDEX (search_type)
    %% INDEX (created_at)

    %% ai_modelsè¡¨ç´¢å¼•ï¼š
    %% PRIMARY KEY (id)
    %% UNIQUE KEY (model_type, provider, model_name)
    %% INDEX (model_type)
    %% INDEX (provider)
    %% INDEX (is_active)

    %% index_jobsè¡¨ç´¢å¼•ï¼š
    %% PRIMARY KEY (id)
    %% INDEX (folder_path)
    %% INDEX (job_type)
    %% INDEX (status)
    %% INDEX (started_at)

    %% file_contentè¡¨ç´¢å¼•ï¼š
    %% PRIMARY KEY (id)
    %% INDEX (file_id)
    %% INDEX (content_type)
    %% INDEX (created_at)

    %% app_settingsè¡¨ç´¢å¼•ï¼š
    %% PRIMARY KEY (id)
    %% UNIQUE KEY (setting_key)
```

#### 2.1.2 è¡¨ç»“æ„è¯¦ç»†è®¾è®¡

##### 2.2.1 files æ–‡ä»¶ç´¢å¼•è¡¨
å­˜å‚¨æ‰€æœ‰å·²ç´¢å¼•æ–‡ä»¶çš„åŸºæœ¬ä¿¡æ¯ã€å…ƒæ•°æ®å’Œç´¢å¼•çŠ¶æ€ã€‚

**åŸºç¡€å­—æ®µ**
| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | è¯´æ˜ | ç´¢å¼• |
|--------|----------|------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | ä¸»é”®ï¼Œå”¯ä¸€æ ‡è¯†æ–‡ä»¶ | PRIMARY |
| file_path | TEXT | UNIQUE NOT NULL | æ–‡ä»¶ç»å¯¹è·¯å¾„ï¼Œç”¨äºå»é‡å’Œå®šä½ | UNIQUE |
| file_name | TEXT | NOT NULL | æ–‡ä»¶åï¼ˆå«æ‰©å±•åï¼‰ | INDEX |
| file_extension | TEXT | NOT NULL | æ–‡ä»¶æ‰©å±•åï¼ˆå¦‚.pdfã€.mp3ï¼‰ | INDEX |
| file_type | TEXT | NOT NULL | æ–‡ä»¶ç±»å‹ï¼švideo/audio/document/image | INDEX |
| file_size | INTEGER | NOT NULL | æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰ | |
| created_at | DATETIME | NOT NULL | æ–‡ä»¶åˆ›å»ºæ—¶é—´ | INDEX |
| modified_at | DATETIME | NOT NULL | æ–‡ä»¶æœ€åä¿®æ”¹æ—¶é—´ | INDEX |
| indexed_at | DATETIME | NOT NULL | ç´¢å¼•å»ºç«‹æ—¶é—´ | INDEX |
| content_hash | TEXT | NOT NULL | æ–‡ä»¶å†…å®¹SHA256å“ˆå¸Œï¼Œç”¨äºå˜æ›´æ£€æµ‹ | INDEX |

**ç´¢å¼•ç›¸å…³å­—æ®µ**
| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | è¯´æ˜ | ç´¢å¼• |
|--------|----------|------|------|------|
| is_indexed | BOOLEAN | DEFAULT FALSE | æ˜¯å¦å·²ç´¢å¼• | INDEX |
| is_content_parsed | BOOLEAN | DEFAULT FALSE | æ˜¯å¦å·²è§£æå†…å®¹ | INDEX |
| index_status | TEXT | DEFAULT 'pending' | ç´¢å¼•çŠ¶æ€ï¼špending/processing/completed/failed | INDEX |

**æ‰©å±•å…ƒæ•°æ®å­—æ®µ**
| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | è¯´æ˜ | ç´¢å¼• |
|--------|----------|------|------|------|
| mime_type | TEXT | | MIMEç±»å‹ | |
| title | TEXT | | æ–‡æ¡£æ ‡é¢˜ | |
| author | TEXT | | ä½œè€… | |
| keywords | TEXT | | å…³é”®è¯ï¼Œé€—å·åˆ†éš” | |

**å†…å®¹ç»Ÿè®¡å­—æ®µ**
| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | è¯´æ˜ | ç´¢å¼• |
|--------|----------|------|------|------|
| content_length | INTEGER | DEFAULT 0 | å†…å®¹é•¿åº¦ï¼ˆå­—ç¬¦æ•°ï¼‰ | |
| word_count | INTEGER | DEFAULT 0 | è¯æ±‡æ•°é‡ | |

**å¤„ç†è´¨é‡è¯„ä¼°å­—æ®µ**
| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | è¯´æ˜ | ç´¢å¼• |
|--------|----------|------|------|------|
| parse_confidence | REAL | DEFAULT 0.0 | è§£æç½®ä¿¡åº¦(0-1) | INDEX |
| index_quality_score | REAL | DEFAULT 0.0 | ç´¢å¼•è´¨é‡è¯„åˆ†(0-1) | INDEX |

**é”™è¯¯å¤„ç†å­—æ®µ**
| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | è¯´æ˜ | ç´¢å¼• |
|--------|----------|------|------|------|
| last_error | TEXT | | æœ€åé”™è¯¯ä¿¡æ¯ | |
| retry_count | INTEGER | DEFAULT 0 | é‡è¯•æ¬¡æ•° | |

**ç‰ˆæœ¬æ§åˆ¶å­—æ®µ**
| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | è¯´æ˜ | ç´¢å¼• |
|--------|----------|------|------|------|
| index_version | TEXT | DEFAULT '1.0' | ç´¢å¼•ç‰ˆæœ¬ | |
| needs_reindex | BOOLEAN | DEFAULT FALSE | æ˜¯å¦éœ€è¦é‡æ–°ç´¢å¼• | INDEX |

**åˆ†å—æ”¯æŒå­—æ®µ (v2.0æ–°å¢)**
| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | è¯´æ˜ | ç´¢å¼• |
|--------|----------|------|------|------|
| is_chunked | BOOLEAN | DEFAULT FALSE | æ˜¯å¦å·²åˆ†å—å¤„ç† | INDEX |
| total_chunks | INTEGER | DEFAULT 1 | æ€»åˆ†å—æ•°é‡ | INDEX |
| chunk_strategy | TEXT | DEFAULT '500+50' | åˆ†å—ç­–ç•¥(å¦‚500+50) | |
| avg_chunk_size | INTEGER | DEFAULT 500 | å¹³å‡åˆ†å—å¤§å° | |

#### 2.2.2 file_chunks æ–‡ä»¶åˆ†å—è¡¨ (v2.0æ–°å¢)
å­˜å‚¨æ–‡ä»¶åˆ†å—åçš„æ–‡æœ¬å—å’Œç´¢å¼•ä¿¡æ¯ï¼Œæ”¯æŒç²¾ç¡®æœç´¢å’Œä¸Šä¸‹æ–‡æå–ã€‚

| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | è¯´æ˜ | ç´¢å¼• |
|--------|----------|------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | ä¸»é”®ï¼Œå”¯ä¸€æ ‡è¯†åˆ†å— | PRIMARY |
| file_id | INTEGER | NOT NULL | å…³è”çš„æ–‡ä»¶ID | FOREIGN KEY, INDEX |
| chunk_index | INTEGER | NOT NULL | åˆ†å—åºå·(ä»0å¼€å§‹) | INDEX |
| content | TEXT | NOT NULL | åˆ†å—æ–‡æœ¬å†…å®¹ | |
| content_length | INTEGER | DEFAULT 0 | åˆ†å—å†…å®¹é•¿åº¦ | |
| start_position | INTEGER | NOT NULL | åœ¨åŸæ–‡ä¸­çš„èµ·å§‹ä½ç½® | |
| end_position | INTEGER | NOT NULL | åœ¨åŸæ–‡ä¸­çš„ç»“æŸä½ç½® | |

**ç´¢å¼•å…³è”å­—æ®µ**
| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | è¯´æ˜ | ç´¢å¼• |
|--------|----------|------|------|------|
| faiss_index_id | INTEGER | | å…³è”Faisså‘é‡ç´¢å¼•ID | INDEX |
| whoosh_doc_id | TEXT | | å…³è”Whooshæ–‡æ¡£ID | |

**å¤„ç†çŠ¶æ€å­—æ®µ**
| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | è¯´æ˜ | ç´¢å¼• |
|--------|----------|------|------|------|
| is_indexed | BOOLEAN | DEFAULT FALSE | æ˜¯å¦å·²ç´¢å¼• | INDEX |
| index_status | TEXT | DEFAULT 'pending' | åˆ†å—ç´¢å¼•çŠ¶æ€ | |

**è´¨é‡è¯„ä¼°å­—æ®µ**
| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | è¯´æ˜ | ç´¢å¼• |
|--------|----------|------|------|------|
| embedding_quality | REAL | DEFAULT 0.0 | å‘é‡è´¨é‡è¯„åˆ† | |

**æ—¶é—´æˆ³å­—æ®µ**
| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | è¯´æ˜ | ç´¢å¼• |
|--------|----------|------|------|------|
| created_at | DATETIME | NOT NULL DEFAULT CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ | INDEX |
| indexed_at | DATETIME | | ç´¢å¼•æ—¶é—´ | |

**å”¯ä¸€çº¦æŸ**
- `UNIQUE(file_id, chunk_index)` - ç¡®ä¿åŒä¸€æ–‡ä»¶å†…åˆ†å—ç´¢å¼•å”¯ä¸€

#### 2.2.3 search_history æœç´¢å†å²è¡¨
è®°å½•ç”¨æˆ·æœç´¢è¡Œä¸ºï¼Œç”¨äºä¼˜åŒ–æœç´¢ä½“éªŒå’Œç»Ÿè®¡åˆ†æã€‚

| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | è¯´æ˜ | ç´¢å¼• |
|--------|----------|------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | ä¸»é”®ï¼Œå”¯ä¸€æ ‡è¯†æœç´¢è®°å½• | PRIMARY |
| search_query | TEXT | NOT NULL | ç”¨æˆ·æœç´¢æŸ¥è¯¢å†…å®¹ | INDEX |
| input_type | TEXT | NOT NULL | è¾“å…¥ç±»å‹ï¼štext/voice/image | INDEX |
| search_type | TEXT | NOT NULL | æœç´¢ç±»å‹ï¼šsemantic/fulltext/hybrid | INDEX |
| ai_model_used | TEXT | | ä½¿ç”¨çš„AIæ¨¡å‹åç§° | |
| result_count | INTEGER | NOT NULL DEFAULT 0 | æœç´¢ç»“æœæ•°é‡ | |
| response_time | REAL | NOT NULL | å“åº”æ—¶é—´ï¼ˆç§’ï¼‰ | |
| created_at | DATETIME | NOT NULL DEFAULT CURRENT_TIMESTAMP | æœç´¢æ—¶é—´ | INDEX |

#### 2.2.4 ai_models AIæ¨¡å‹é…ç½®è¡¨
ç®¡ç†AIæ¨¡å‹çš„é…ç½®ä¿¡æ¯å’ŒçŠ¶æ€ã€‚

| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | è¯´æ˜ | ç´¢å¼• |
|--------|----------|------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | ä¸»é”®ï¼Œå”¯ä¸€æ ‡è¯†æ¨¡å‹é…ç½® | PRIMARY |
| model_type | TEXT | NOT NULL | æ¨¡å‹ç±»å‹ï¼šembedding/speech/vision/llm | INDEX |
| provider | TEXT | NOT NULL | æä¾›å•†ç±»å‹ï¼šlocal/cloud | INDEX |
| model_name | TEXT | NOT NULL | æ¨¡å‹åç§°ï¼ˆå¦‚BGE-M3ã€faster-whisperï¼‰ | |
| config_json | TEXT | NOT NULL | JSONæ ¼å¼çš„æ¨¡å‹é…ç½®å‚æ•° | |
| is_active | BOOLEAN | DEFAULT TRUE | æ˜¯å¦å¯ç”¨è¯¥æ¨¡å‹ | INDEX |
| created_at | DATETIME | NOT NULL DEFAULT CURRENT_TIMESTAMP | é…ç½®åˆ›å»ºæ—¶é—´ | |
| updated_at | DATETIME | NOT NULL DEFAULT CURRENT_TIMESTAMP | é…ç½®æ›´æ–°æ—¶é—´ | |

#### 2.2.5 index_jobs ç´¢å¼•ä»»åŠ¡è¡¨
ç®¡ç†æ–‡ä»¶ç´¢å¼•ä»»åŠ¡çš„æ‰§è¡ŒçŠ¶æ€å’Œè¿›åº¦ã€‚

| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | è¯´æ˜ | ç´¢å¼• |
|--------|----------|------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | ä¸»é”®ï¼Œå”¯ä¸€æ ‡è¯†ç´¢å¼•ä»»åŠ¡ | PRIMARY |
| folder_path | TEXT | NOT NULL | ç´¢å¼•ç›®æ ‡æ–‡ä»¶å¤¹è·¯å¾„ | INDEX |
| job_type | TEXT | NOT NULL | ä»»åŠ¡ç±»å‹ï¼šcreate/update/rebuild/delete | INDEX |
| status | TEXT | NOT NULL DEFAULT 'pending' | ä»»åŠ¡çŠ¶æ€ï¼špending/processing/completed/failed | INDEX |
| total_files | INTEGER | DEFAULT 0 | æ€»æ–‡ä»¶æ•° | |
| processed_files | INTEGER | DEFAULT 0 | å·²å¤„ç†æ–‡ä»¶æ•° | |
| error_count | INTEGER | DEFAULT 0 | å¤„ç†å¤±è´¥æ–‡ä»¶æ•° | |
| started_at | DATETIME | | ä»»åŠ¡å¼€å§‹æ—¶é—´ | |
| completed_at | DATETIME | | ä»»åŠ¡å®Œæˆæ—¶é—´ | |
| error_message | TEXT | | é”™è¯¯ä¿¡æ¯ | |

#### 2.2.6 file_content æ–‡ä»¶å†…å®¹è¡¨
å­˜å‚¨æ–‡ä»¶è§£æåçš„æ–‡æœ¬å†…å®¹å’Œç›¸å…³å…ƒæ•°æ®ï¼Œæ”¯æŒå¢é‡æ›´æ–°å’Œè´¨é‡è·Ÿè¸ªã€‚

| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | è¯´æ˜ | ç´¢å¼• |
|--------|----------|------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | ä¸»é”®ï¼Œå”¯ä¸€æ ‡è¯†å†…å®¹è®°å½• | PRIMARY |
| file_id | INTEGER | NOT NULL | å…³è”çš„æ–‡ä»¶ID | FOREIGN KEY, UNIQUE |

**å†…å®¹è§£æå­—æ®µ**
| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | è¯´æ˜ | ç´¢å¼• |
|--------|----------|------|------|------|
| title | TEXT | | æå–çš„æ ‡é¢˜ | |
| content | TEXT | | è§£æçš„æ–‡æœ¬å†…å®¹ | |
| content_length | INTEGER | DEFAULT 0 | å†…å®¹é•¿åº¦ï¼ˆå­—ç¬¦æ•°ï¼‰ | |
| word_count | INTEGER | DEFAULT 0 | è¯æ±‡æ•°é‡ | |

**è§£æä¿¡æ¯å­—æ®µ**
| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | è¯´æ˜ | ç´¢å¼• |
|--------|----------|------|------|------|
| language | TEXT | | æ£€æµ‹åˆ°çš„è¯­è¨€(zh/en/unknown) | INDEX |
| encoding | TEXT | | æ–‡ä»¶ç¼–ç  | |
| confidence | REAL | DEFAULT 0.0 | å†…å®¹è§£æç½®ä¿¡åº¦(0-1) | |
| parse_method | TEXT | | è§£ææ–¹æ³• | |

**å¤„ç†çŠ¶æ€å­—æ®µ**
| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | è¯´æ˜ | ç´¢å¼• |
|--------|----------|------|------|------|
| is_parsed | BOOLEAN | DEFAULT FALSE | æ˜¯å¦å·²è§£æ | INDEX |
| has_error | BOOLEAN | DEFAULT FALSE | æ˜¯å¦æœ‰è§£æé”™è¯¯ | INDEX |
| error_message | TEXT | | è§£æé”™è¯¯ä¿¡æ¯ | |

**æ—¶é—´æˆ³å­—æ®µ**
| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | è¯´æ˜ | ç´¢å¼• |
|--------|----------|------|------|------|
| parsed_at | DATETIME | | è§£ææ—¶é—´ | INDEX |
| updated_at | DATETIME | NOT NULL DEFAULT CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ | INDEX |

#### 2.2.7 app_settings åº”ç”¨è®¾ç½®è¡¨
å­˜å‚¨åº”ç”¨çš„å…¨å±€é…ç½®è®¾ç½®ã€‚

| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | è¯´æ˜ | ç´¢å¼• |
|--------|----------|------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | ä¸»é”® | PRIMARY |
| setting_key | TEXT | UNIQUE NOT NULL | è®¾ç½®é”®å | UNIQUE |
| setting_value | TEXT | | è®¾ç½®å€¼ | |
| setting_type | TEXT | NOT NULL | å€¼ç±»å‹ï¼šstring/integer/boolean/json | |
| description | TEXT | | è®¾ç½®è¯´æ˜ | |
| updated_at | DATETIME | NOT NULL DEFAULT CURRENT_TIMESTAMP | è®¾ç½®æ›´æ–°æ—¶é—´ | |

### 2.2 Faiss å‘é‡ç´¢å¼•è®¾è®¡

#### 2.2.1 ç´¢å¼•ç»“æ„
Faissç”¨äºé«˜æ•ˆçš„å‘é‡ç›¸ä¼¼åº¦æœç´¢ï¼Œä¸»è¦å­˜å‚¨BGE-M3ç”Ÿæˆçš„æ–‡æœ¬åµŒå…¥å‘é‡ã€‚

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|----| ----- |
| **å‘é‡ç»´åº¦** | 768 | BGE-M3æ¨¡å‹ç”Ÿæˆçš„å‘é‡ç»´åº¦ |
| **ç´¢å¼•ç±»å‹** | IVF_PQ | å€’æ’ç´¢å¼• + ä¹˜ç§¯é‡åŒ– |
| **èšç±»æ•°é‡** | 100 | IVFç´¢å¼•çš„èšç±»æ•°é‡ |
| **PQç¼–ç å‚æ•°** | 32 | ä¹˜ç§¯é‡åŒ–ç¼–ç å‚æ•° |
| **æ¢æµ‹æ•°é‡** | 10 | æœç´¢æ—¶çš„æ¢æµ‹æ•°é‡ |

#### 2.2.2 å­˜å‚¨ç»“æ„ (v2.0åˆ†å—æ”¯æŒ)
```
data/indexes/faiss/
â”œâ”€â”€ document_index.faiss         # Faisså‘é‡ç´¢å¼•æ–‡ä»¶
â”œâ”€â”€ chunk_index.faiss            # åˆ†å—å‘é‡ç´¢å¼•æ–‡ä»¶ (v2.0æ–°å¢)
â”œâ”€â”€ metadata.pkl                # æ–‡æ¡£å‘é‡å…ƒæ•°æ®ï¼ˆpickleæ ¼å¼ï¼‰
â”œâ”€â”€ chunk_metadata.pkl           # åˆ†å—å‘é‡å…ƒæ•°æ® (v2.0æ–°å¢)
â”‚   {
â”‚       vector_id: {
â”‚           "file_id": 1,
â”‚           "chunk_id": 123,
â”‚           "chunk_index": 5,
â”‚           "chunk_text": "æ–‡æ¡£å†…å®¹ç‰‡æ®µ",
â”‚           "start_position": 2000,
â”‚           "end_position": 2500,
â”‚           "file_type": "document",
â”‚           "embedding_model": "BGE-M3",
â”‚           "chunk_strategy": "500+50",
â”‚           "created_at": "2025-01-01T00:00:00Z"
â”‚       }
â”‚   }
â”œâ”€â”€ index_config.json            # ç´¢å¼•é…ç½®ä¿¡æ¯
â”‚   {
â”‚       "embedding_dim": 768,
â”‚       "index_type": "IVF_PQ",
â”‚       "nlist": 100,
â”‚       "m": 32,
â”‚       "model_name": "BAAI/bge-m3",
â”‚       "created_at": "2025-01-01T00:00:00Z",
â”‚       "total_vectors": 100000,
â”‚       "chunking_enabled": true,         # v2.0æ–°å¢
â”‚       "chunk_strategy": "500+50",       # v2.0æ–°å¢
â”‚       "chunk_overlap": 50,              # v2.0æ–°å¢
â”‚       "avg_chunks_per_file": 200        # v2.0æ–°å¢
â”‚   }
â””â”€â”€ id_mapping.json             # IDæ˜ å°„å…³ç³»
    {
        "faiss_vector_id": 12345,
        "sqlite_file_id": 1,
        "chunk_index": 0,             # æ–‡æ¡£çº§åˆ†å—ç´¢å¼•
        "is_chunked": true           # v2.0æ–°å¢
    }
```

#### 2.2.3 å‘é‡å…ƒæ•°æ®è¡¨è®¾è®¡ (v2.0åˆ†å—æ”¯æŒ)
è™½ç„¶Faissæœ¬èº«ä¸ä½¿ç”¨ä¼ ç»Ÿè¡¨ç»“æ„ï¼Œä½†å…¶å…ƒæ•°æ®å¯é€šè¿‡ä»¥ä¸‹ç»“æ„åŒ–ç®¡ç†ï¼š

**ä¼ ç»Ÿæ–‡æ¡£å‘é‡å…ƒæ•°æ®**
| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| **vector_id** | INTEGER | Faisså‘é‡ID |
| **file_id** | INTEGER | å…³è”çš„SQLiteæ–‡ä»¶ID |
| **chunk_index** | INTEGER | æ–‡æ¡£åˆ†ç‰‡ç´¢å¼• |
| **chunk_text** | TEXT | æ–‡æ¡£åˆ†ç‰‡å†…å®¹ |
| **file_type** | TEXT | æ–‡ä»¶ç±»å‹ |
| **embedding_model** | TEXT | ä½¿ç”¨çš„åµŒå…¥æ¨¡å‹ |
| **created_at** | DATETIME | å‘é‡åˆ›å»ºæ—¶é—´ |

**åˆ†å—å‘é‡å…ƒæ•°æ® (v2.0æ–°å¢)**
| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| **vector_id** | INTEGER | Faisså‘é‡ID |
| **file_id** | INTEGER | å…³è”çš„SQLiteæ–‡ä»¶ID |
| **chunk_id** | INTEGER | å…³è”çš„åˆ†å—è®°å½•ID |
| **chunk_index** | INTEGER | åˆ†å—åºå·(ä»0å¼€å§‹) |
| **chunk_text** | TEXT | åˆ†å—æ–‡æœ¬å†…å®¹ |
| **start_position** | INTEGER | åœ¨åŸæ–‡ä¸­çš„èµ·å§‹ä½ç½® |
| **end_position** | INTEGER | åœ¨åŸæ–‡ä¸­çš„ç»“æŸä½ç½® |
| **chunk_strategy** | TEXT | åˆ†å—ç­–ç•¥(å¦‚500+50) |
| **file_type** | TEXT | æ–‡ä»¶ç±»å‹ |
| **embedding_model** | TEXT | ä½¿ç”¨çš„åµŒå…¥æ¨¡å‹ |
| **embedding_quality** | REAL | å‘é‡è´¨é‡è¯„åˆ† |
| **created_at** | DATETIME | å‘é‡åˆ›å»ºæ—¶é—´ |

### 2.3 Whoosh å…¨æ–‡ç´¢å¼•è®¾è®¡

#### 2.3.1 ç´¢å¼•Schemaè®¾è®¡ (v2.0åˆ†å—æ”¯æŒ)
```python
from whoosh.fields import Schema, TEXT, ID, DATETIME, KEYWORD, NUMERIC
from whoosh.analysis import ChineseAnalyzer

# ä¸­æ–‡åˆ†è¯å™¨
chinese_analyzer = ChineseAnalyzer()

# ä¼ ç»Ÿæ–‡æ¡£Schemaå®šä¹‰
document_schema = Schema(
    # æ–‡ä»¶åŸºæœ¬ä¿¡æ¯
    file_id=ID(stored=True, unique=True),                    # æ–‡ä»¶ID
    file_path=ID(stored=True),                               # æ–‡ä»¶è·¯å¾„
    file_name=TEXT(stored=True, analyzer=chinese_analyzer),  # æ–‡ä»¶å
    file_extension=ID(stored=True),                          # æ–‡ä»¶æ‰©å±•å
    file_type=KEYWORD(stored=True),                          # æ–‡ä»¶ç±»å‹

    # å†…å®¹ä¿¡æ¯
    title=TEXT(stored=True, analyzer=chinese_analyzer),      # æ–‡æ¡£æ ‡é¢˜
    content=TEXT(stored=True, phrase=True, analyzer=chinese_analyzer),  # æ–‡æ¡£å†…å®¹
    tags=KEYWORD(stored=True, commas=True),                  # æ ‡ç­¾
    description=TEXT(stored=True, analyzer=chinese_analyzer), # æè¿°

    # å…ƒä¿¡æ¯
    file_size=NUMERIC(stored=True),                          # æ–‡ä»¶å¤§å°
    author=TEXT(stored=True, analyzer=chinese_analyzer),    # ä½œè€…
    language=KEYWORD(stored=True),                           # è¯­è¨€

    # æ—¶é—´ä¿¡æ¯
    created_at=DATETIME(stored=True),                        # åˆ›å»ºæ—¶é—´
    modified_at=DATETIME(stored=True),                       # ä¿®æ”¹æ—¶é—´
    indexed_at=DATETIME(stored=True)                         # ç´¢å¼•æ—¶é—´
)

# åˆ†å—Schemaå®šä¹‰ (v2.0æ–°å¢)
chunk_schema = Schema(
    # åˆ†å—åŸºæœ¬ä¿¡æ¯
    chunk_id=ID(stored=True, unique=True),                  # åˆ†å—ID
    file_id=ID(stored=True),                                 # å…³è”æ–‡ä»¶ID
    chunk_index=NUMERIC(stored=True),                        # åˆ†å—åºå·
    file_path=ID(stored=True),                               # åŸæ–‡ä»¶è·¯å¾„
    file_name=TEXT(stored=True, analyzer=chinese_analyzer),  # åŸæ–‡ä»¶å
    file_type=KEYWORD(stored=True),                          # æ–‡ä»¶ç±»å‹

    # åˆ†å—å†…å®¹ä¿¡æ¯
    chunk_content=TEXT(stored=True, phrase=True, analyzer=chinese_analyzer),  # åˆ†å—å†…å®¹
    title=TEXT(stored=True, analyzer=chinese_analyzer),      # åŸæ–‡æ¡£æ ‡é¢˜

    # åˆ†å—ä½ç½®ä¿¡æ¯
    start_position=NUMERIC(stored=True),                    # èµ·å§‹ä½ç½®
    end_position=NUMERIC(stored=True),                      # ç»“æŸä½ç½®
    chunk_strategy=KEYWORD(stored=True),                     # åˆ†å—ç­–ç•¥

    # å…ƒä¿¡æ¯
    file_size=NUMERIC(stored=True),                          # åŸæ–‡ä»¶å¤§å°
    author=TEXT(stored=True, analyzer=chinese_analyzer),    # åŸä½œè€…
    language=KEYWORD(stored=True),                           # åŸè¯­è¨€

    # è´¨é‡è¯„ä¼°
    embedding_quality=NUMERIC(stored=True),                  # å‘é‡è´¨é‡è¯„åˆ†

    # æ—¶é—´ä¿¡æ¯
    created_at=DATETIME(stored=True),                        # åˆ›å»ºæ—¶é—´
    indexed_at=DATETIME(stored=True)                         # ç´¢å¼•æ—¶é—´
)
```

#### 2.3.2 å­˜å‚¨ç»“æ„ (v2.0åˆ†å—æ”¯æŒ)
```
data/indexes/whoosh/
â”œâ”€â”€ document/                  # ä¼ ç»Ÿæ–‡æ¡£ç´¢å¼•ç›®å½•
â”‚   â”œâ”€â”€ MAIN_0.seg           # ä¸»ç´¢å¼•æ®µ
â”‚   â”œâ”€â”€ segments_0001       # æ®µä¿¡æ¯
â”‚   â”œâ”€â”€ _toc.json           # ç´¢å¼•ç›®å½•
â”‚   â”œâ”€â”€ _per.doc            # æ–‡æ¡£æ•°æ®
â”‚   â”œâ”€â”€ _stored_0.frj       # å­˜å‚¨å­—æ®µæ•°æ®
â”‚   â”œâ”€â”€ _fieldinfo_0.pym    # å­—æ®µä¿¡æ¯
â”‚   â””â”€â”€ _locks/             # ç´¢å¼•é”æ–‡ä»¶
â”œâ”€â”€ chunks/                    # åˆ†å—ç´¢å¼•ç›®å½• (v2.0æ–°å¢)
â”‚   â”œâ”€â”€ MAIN_0.seg          # åˆ†å—ä¸»ç´¢å¼•æ®µ
â”‚   â”œâ”€â”€ segments_0001      # åˆ†å—æ®µä¿¡æ¯
â”‚   â”œâ”€â”€ _toc.json          # åˆ†å—ç´¢å¼•ç›®å½•
â”‚   â”œâ”€â”€ _per.doc           # åˆ†å—æ–‡æ¡£æ•°æ®
â”‚   â”œâ”€â”€ _stored_0.frj      # åˆ†å—å­˜å‚¨å­—æ®µæ•°æ®
â”‚   â”œâ”€â”€ _fieldinfo_0.pym   # åˆ†å—å­—æ®µä¿¡æ¯
â”‚   â””â”€â”€ _locks/            # åˆ†å—ç´¢å¼•é”æ–‡ä»¶
â””â”€â”€ index_config.json         # ç»Ÿä¸€ç´¢å¼•é…ç½®
    {
        "analyzer": "ChineseAnalyzer",
        "created_at": "2025-01-01T00:00:00Z",
        "schema_version": "2.0",
        "total_docs": 50000,
        "total_chunks": 2000000,          # v2.0æ–°å¢
        "chunking_enabled": true,          # v2.0æ–°å¢
        "chunk_strategy": "500+50",        # v2.0æ–°å¢
        "avg_chunks_per_file": 40          # v2.0æ–°å¢
    }
```

#### 2.3.3 å…¨æ–‡ç´¢å¼•å­—æ®µè¡¨ (v2.0åˆ†å—æ”¯æŒ)
Whooshç´¢å¼•å­—æ®µçš„è¯¦ç»†è®¾è®¡ï¼š

**ä¼ ç»Ÿæ–‡æ¡£ç´¢å¼•å­—æ®µ**
| å­—æ®µå | Whooshç±»å‹ | å­˜å‚¨å±æ€§ | åˆ†è¯å™¨ | è¯´æ˜ |
|--------|-----------|---------|--------|------|
| **file_id** | ID | stored=True, unique=True | - | å”¯ä¸€æ–‡ä»¶æ ‡è¯† |
| **file_path** | ID | stored=True | - | æ–‡ä»¶è·¯å¾„ |
| **file_name** | TEXT | stored=True | ChineseAnalyzer | æ–‡ä»¶åï¼Œæ”¯æŒä¸­æ–‡æœç´¢ |
| **file_extension** | ID | stored=True | - | æ–‡ä»¶æ‰©å±•å |
| **file_type** | KEYWORD | stored=True | - | æ–‡ä»¶ç±»å‹ |
| **title** | TEXT | stored=True | ChineseAnalyzer | æ–‡æ¡£æ ‡é¢˜ |
| **content** | TEXT | stored=True, phrase=True | ChineseAnalyzer | æ–‡æ¡£æ­£æ–‡å†…å®¹ |
| **tags** | KEYWORD | stored=True, commas=True | - | æ ‡ç­¾ï¼Œæ”¯æŒå¤šå€¼ |
| **description** | TEXT | stored=True | ChineseAnalyzer | æ–‡æ¡£æè¿° |
| **file_size** | NUMERIC | stored=True | - | æ–‡ä»¶å¤§å° |
| **author** | TEXT | stored=True | ChineseAnalyzer | ä½œè€…ä¿¡æ¯ |
| **language** | KEYWORD | stored=True | - | æ–‡æ¡£è¯­è¨€ |
| **created_at** | DATETIME | stored=True | - | åˆ›å»ºæ—¶é—´ |
| **modified_at** | DATETIME | stored=True | - | ä¿®æ”¹æ—¶é—´ |
| **indexed_at** | DATETIME | stored=True | - | ç´¢å¼•æ—¶é—´ |

**åˆ†å—ç´¢å¼•å­—æ®µ (v2.0æ–°å¢)**
| å­—æ®µå | Whooshç±»å‹ | å­˜å‚¨å±æ€§ | åˆ†è¯å™¨ | è¯´æ˜ |
|--------|-----------|---------|--------|------|
| **chunk_id** | ID | stored=True, unique=True | - | å”¯ä¸€åˆ†å—æ ‡è¯† |
| **file_id** | ID | stored=True | - | å…³è”æ–‡ä»¶ID |
| **chunk_index** | NUMERIC | stored=True | - | åˆ†å—åºå· |
| **file_path** | ID | stored=True | - | åŸæ–‡ä»¶è·¯å¾„ |
| **file_name** | TEXT | stored=True | ChineseAnalyzer | åŸæ–‡ä»¶å |
| **file_type** | KEYWORD | stored=True | - | æ–‡ä»¶ç±»å‹ |
| **chunk_content** | TEXT | stored=True, phrase=True | ChineseAnalyzer | åˆ†å—å†…å®¹ï¼Œæ”¯æŒçŸ­è¯­æœç´¢ |
| **title** | TEXT | stored=True | ChineseAnalyzer | åŸæ–‡æ¡£æ ‡é¢˜ |
| **start_position** | NUMERIC | stored=True | - | èµ·å§‹ä½ç½® |
| **end_position** | NUMERIC | stored=True | - | ç»“æŸä½ç½® |
| **chunk_strategy** | KEYWORD | stored=True | - | åˆ†å—ç­–ç•¥ |
| **file_size** | NUMERIC | stored=True | - | åŸæ–‡ä»¶å¤§å° |
| **author** | TEXT | stored=True | ChineseAnalyzer | åŸä½œè€…ä¿¡æ¯ |
| **language** | KEYWORD | stored=True | - | åŸæ–‡æ¡£è¯­è¨€ |
| **embedding_quality** | NUMERIC | stored=True | - | å‘é‡è´¨é‡è¯„åˆ† |
| **created_at** | DATETIME | stored=True | - | åˆ›å»ºæ—¶é—´ |
| **indexed_at** | DATETIME | stored=True | - | ç´¢å¼•æ—¶é—´ |

---

## ğŸ“‹ å®ç°ä¸€è‡´æ€§æ£€æŸ¥

### âœ… æ•°æ®åº“è®¾è®¡å®ç°çŠ¶æ€

**æ£€æŸ¥æ—¶é—´**: 2025å¹´11æœˆ28æ—¥
**æ£€æŸ¥èŒƒå›´**: æ•°æ®åº“è®¾è®¡æ–‡æ¡£ä¸åç«¯æ¨¡å‹å®ç° (v2.0åˆ†å—æ”¯æŒ)
**ä¸€è‡´æ€§ç»“æœ**: v1.0å®Œå…¨ä¸€è‡´, v2.0åˆ†å—æ”¯æŒå¾…å®ç°

#### å·²å®Œæˆçš„ä¿®å¤å·¥ä½œ

1. **âœ… è¡¥å……ç¼ºå¤±è¡¨**: åˆ›å»ºäº† `app_settings` è¡¨çš„å®Œæ•´å®ç°
2. **âœ… ç»Ÿä¸€è¡¨åå‘½å**: å°† `file_contents` ç»Ÿä¸€ä¸º `file_content`ï¼Œç¬¦åˆè®¾è®¡æ–‡æ¡£è§„èŒƒ
3. **âœ… éªŒè¯æ•°æ®å®Œæ•´æ€§**: ç¡®è®¤æ‰€æœ‰6ä¸ªè¡¨åœ¨æ•°æ®åº“ä¸­æ­£ç¡®åˆ›å»º
4. **âœ… å­—æ®µæ˜ å°„éªŒè¯**: æ‰€æœ‰å­—æ®µå®šä¹‰ä¸è®¾è®¡æ–‡æ¡£å®Œå…¨åŒ¹é…
5. **âœ… ä¿®å¤æ¨¡å‹å¯¼å‡º**: ä¿®å¤äº† `AppSettingsModel` åœ¨ `__init__.py` ä¸­ç¼ºå¤±çš„å¯¼å‡ºé—®é¢˜ *(2025-11-25)*

#### v2.0åˆ†å—æ”¯æŒè®¾è®¡ (æ–°å¢)

| è®¾è®¡æ–‡æ¡£è¡¨å | å®ç°æ¨¡å‹ç±» | æ•°æ®åº“è¡¨å | çŠ¶æ€ | å¤‡æ³¨ |
|-------------|-----------|-----------|------|------|
| files | FileModel | files | âœ… å·²å®ç° | éœ€è¦æ·»åŠ 4ä¸ªåˆ†å—å­—æ®µ |
| file_chunks | FileChunkModel | file_chunks | ğŸ”„ å¾…å®ç° | v2.0æ–°å¢åˆ†å—è¡¨ |
| file_content | FileContentModel | file_content | âœ… å·²å®ç° | ä¿æŒç°æœ‰å®ç° |
| search_history | SearchHistoryModel | search_history | âœ… å·²å®ç° | ä¿æŒç°æœ‰å®ç° |
| ai_models | AIModelModel | ai_models | âœ… å·²å®ç° | ä¿æŒç°æœ‰å®ç° |
| index_jobs | IndexJobModel | index_jobs | âœ… å·²å®ç° | ä¿æŒç°æœ‰å®ç° |
| app_settings | AppSettingsModel | app_settings | âœ… å·²å®ç° | ä¿æŒç°æœ‰å®ç° |

#### v2.0éœ€è¦å®ç°çš„ä¿®æ”¹

**filesè¡¨æ–°å¢å­—æ®µ**:
- `is_chunked`: BOOLEAN DEFAULT FALSE - æ˜¯å¦å·²åˆ†å—å¤„ç†
- `total_chunks`: INTEGER DEFAULT 1 - æ€»åˆ†å—æ•°é‡
- `chunk_strategy`: TEXT DEFAULT '500+50' - åˆ†å—ç­–ç•¥
- `avg_chunk_size`: INTEGER DEFAULT 500 - å¹³å‡åˆ†å—å¤§å°

**æ–°å¢è¡¨éœ€è¦å®ç°**:
1. `file_chunks` - æ–‡ä»¶åˆ†å—è¡¨

**æ€»ä½“å®Œæˆåº¦**:
- v1.0 (å½“å‰ç‰ˆæœ¬): 100% å®Œæˆ
- v2.0 (åˆ†å—æ”¯æŒ): 0% å®Œæˆï¼Œå¾…å®ç°

## ğŸ†• æ–°å¢APIå¯¹åº”çš„æ•°æ®åº“æ“ä½œ

### 3.1 æœç´¢å†å²ç®¡ç†API
åŸºäº`search_history`è¡¨å®ç°çš„æ–°å¢APIï¼š

| APIæ¥å£ | æ•°æ®åº“æ“ä½œ | å¯¹åº”è¡¨ | è¯´æ˜ |
|---------|-----------|--------|------|
| DELETE /api/search/history/{id} | DELETE FROM search_history WHERE id = ? | search_history | åˆ é™¤å•æ¡å†å²è®°å½• |
| DELETE /api/search/history | DELETE FROM search_history | search_history | æ¸…ç©ºæ‰€æœ‰å†å²è®°å½• |
| GET /api/search/suggestions | SELECT DISTINCT search_query FROM search_history WHERE search_query LIKE ? | search_history | åŸºäºå†å²æŸ¥è¯¢æä¾›æœç´¢å»ºè®® |

### 3.2 åº”ç”¨æ—¥å¿—API
åŸºäºç³»ç»Ÿæ—¥å¿—æ–‡ä»¶å®ç°çš„APIï¼š

| APIæ¥å£ | æ•°æ®æº | è¯´æ˜ |
|---------|--------|------|
| GET /api/system/logs | åº”ç”¨æ—¥å¿—æ–‡ä»¶ (`../data/logs/app.log`) | è¯»å–å’Œè¿‡æ»¤æ—¥å¿—å†…å®¹ |
| GET /api/system/logs/download | å†å²æ—¥å¿—æ–‡ä»¶ (`../data/logs/xiaoyao-search-YYYY-MM-DD.log`) | ä¸‹è½½æŒ‡å®šæ—¥æœŸçš„æ—¥å¿—æ–‡ä»¶ |

### 3.3 AIæ¨¡å‹ç®¡ç†å¢å¼º
åŸºäº`ai_models`è¡¨çš„æ‰©å±•æ“ä½œï¼š

| APIæ¥å£ | æ•°æ®åº“æ“ä½œ | å¯¹åº”è¡¨ | è¯´æ˜ |
|---------|-----------|--------|------|
| PUT /api/config/ai-model/{model_id}/toggle | UPDATE ai_models SET is_active = NOT is_active WHERE id = ? | ai_models | åˆ‡æ¢æ¨¡å‹å¯ç”¨çŠ¶æ€ |
| DELETE /api/config/ai-model/{model_id} | DELETE FROM ai_models WHERE id = ? | ai_models | åˆ é™¤æ¨¡å‹é…ç½® |
| GET /api/config/ai-models/default | SELECT * FROM ai_models WHERE is_active = TRUE | ai_models | è·å–é»˜è®¤/æ´»è·ƒæ¨¡å‹ |

### 3.4 åº”ç”¨è®¾ç½®ç®¡ç†
åŸºäº`app_settings`è¡¨çš„å®Œæ•´CRUDæ“ä½œï¼š

| APIæ¥å£ | æ•°æ®åº“æ“ä½œ | å¯¹åº”è¡¨ | è¯´æ˜ |
|---------|-----------|--------|------|
| GET /api/settings | SELECT * FROM app_settings | app_settings | è·å–æ‰€æœ‰åº”ç”¨è®¾ç½® |
| POST /api/settings | UPDATE/INSERT app_settings VALUES | app_settings | æ›´æ–°åº”ç”¨è®¾ç½® |

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0 (åˆ†å—æ”¯æŒè®¾è®¡ç‰ˆ)
**åˆ›å»ºæ—¶é—´**: 2025å¹´11æœˆ24æ—¥
**æœ€åæ›´æ–°**: 2025å¹´11æœˆ28æ—¥
**æ›´æ–°è¯´æ˜**:
1. å®Œæˆäº†æ•°æ®åº“è®¾è®¡æ–‡æ¡£ä¸åç«¯å®ç°çš„ä¸€è‡´æ€§æ£€æŸ¥å’Œä¿®å¤ *(v1.3)*
2. è¡¥å……äº†æ–°å¢APIå¯¹åº”çš„æ•°æ®åº“æ“ä½œè¯´æ˜ *(v1.3)*
3. æ·»åŠ äº†å®Œæ•´çš„æ•°æ®è¡¨åˆ°APIçš„æ˜ å°„å…³ç³» *(v1.3)*
4. å®ç°æ•°æ®åº“è®¾è®¡ä¸æ¥å£æ–‡æ¡£çš„100%ä¸€è‡´æ€§ *(v1.3)*
5. **ğŸ†• v2.0æ–°å¢: æ·»åŠ åˆ†å—æ”¯æŒè®¾è®¡** - æ–°å¢file_chunksåˆ†å—è¡¨
6. **ğŸ†• v2.0æ–°å¢: æ›´æ–°filesè¡¨æ·»åŠ åˆ†å—ç›¸å…³å­—æ®µ** - is_chunkedã€total_chunksç­‰4ä¸ªå­—æ®µ
7. **ğŸ†• v2.0æ–°å¢: æ‰©å±•Faisså’ŒWhooshç´¢å¼•è®¾è®¡** - æ”¯æŒåˆ†å—å‘é‡å’Œåˆ†å—å…¨æ–‡ç´¢å¼•
8. **ğŸ†• v2.0æ–°å¢: å‰ç«¯é€æ˜çš„åˆ†å—æ¶æ„è®¾è®¡** - ä¿æŒAPIæ¥å£å®Œå…¨å…¼å®¹