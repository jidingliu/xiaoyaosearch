# 小遥搜索 XiaoyaoSearch - 数据库设计文档

## 1. 概述

### 1.1 数据库架构
小遥搜索采用**多存储引擎混合架构**：

| 存储引擎 | 用途 | 优势 | 文件位置 |
|---------|------|------|----------|
| **SQLite** | 主数据库，存储元数据 | ACID事务、轻量级、无需服务器 | `data/database/xiaoyao_search.db` |
| **Faiss** | 向量索引，语义搜索 | 高效向量相似度检索 | `data/indexes/faiss/` |
| **Whoosh** | 全文索引，文本搜索 | 中文分词、模糊搜索 | `data/indexes/whoosh/` |

## 2. 存储引擎设计

### 2.1 SQLite 关系数据库设计

#### 2.1.1 数据库ER图

```mermaid
erDiagram
    %% 核心表定义
    files {
        INTEGER id PK "主键，唯一标识文件"
        TEXT file_path UK "文件绝对路径，用于去重和定位"
        TEXT file_name "文件名（含扩展名）"
        TEXT file_extension "文件扩展名（如.pdf、.mp3）"
        TEXT file_type "文件类型：video/audio/document/image"
        INTEGER file_size "文件大小（字节）"
        DATETIME created_at "文件创建时间"
        DATETIME modified_at "文件最后修改时间"
        DATETIME indexed_at "索引建立时间"
        TEXT content_hash "文件内容SHA256哈希，用于变更检测"

        %% 索引相关字段
        INTEGER faiss_index_id "关联Faiss向量索引ID"
        TEXT whoosh_doc_id "关联Whoosh文档ID"
        BOOLEAN is_indexed "是否已索引"
        BOOLEAN is_content_parsed "是否已解析内容"
        TEXT index_status "索引状态：pending/processing/completed/failed"

        %% 扩展元数据字段
        TEXT mime_type "MIME类型"
        TEXT title "文档标题"
        TEXT author "作者"
        TEXT keywords "关键词，逗号分隔"

        %% 内容统计字段
        INTEGER content_length "内容长度（字符数）"
        INTEGER word_count "词汇数量"

        %% 处理质量评估字段
        REAL parse_confidence "解析置信度(0-1)"
        REAL index_quality_score "索引质量评分(0-1)"

        %% 错误处理字段
        TEXT last_error "最后错误信息"
        INTEGER retry_count "重试次数"

        %% 版本控制字段
        TEXT index_version "索引版本"
        BOOLEAN needs_reindex "是否需要重新索引"
    }

    search_history {
        INTEGER id PK "主键，唯一标识搜索记录"
        TEXT search_query "用户搜索查询内容"
        TEXT input_type "输入类型：text/voice/image"
        TEXT search_type "搜索类型：semantic/fulltext/hybrid"
        TEXT ai_model_used "使用的AI模型名称"
        INTEGER result_count "搜索结果数量"
        REAL response_time "响应时间（秒）"
        DATETIME created_at "搜索时间"
    }

    ai_models {
        INTEGER id PK "主键，唯一标识模型配置"
        TEXT model_type "模型类型：embedding/speech/vision/llm"
        TEXT provider "提供商类型：local/cloud"
        TEXT model_name "模型名称（如BGE-M3、faster-whisper）"
        TEXT config_json "JSON格式的模型配置参数"
        BOOLEAN is_active "是否启用该模型"
        DATETIME created_at "配置创建时间"
        DATETIME updated_at "配置更新时间"
    }

    index_jobs {
        INTEGER id PK "主键，唯一标识索引任务"
        TEXT folder_path "索引目标文件夹路径"
        TEXT job_type "任务类型：create/update/rebuild/delete"
        TEXT status "任务状态：pending/processing/completed/failed"
        INTEGER total_files "总文件数"
        INTEGER processed_files "已处理文件数"
        INTEGER error_count "处理失败文件数"
        DATETIME started_at "任务开始时间"
        DATETIME completed_at "任务完成时间"
        TEXT error_message "错误信息"
    }

    file_content {
        INTEGER id PK "主键，唯一标识内容记录"
        INTEGER file_id FK "关联的文件ID"
        TEXT content_type "内容类型：text/metadata/thumbnail"
        TEXT content_text "提取的文本内容（可长文本）"
        TEXT metadata_json "内容元数据（JSON格式）"
        DATETIME created_at "内容创建时间"
    }

    app_settings {
        INTEGER id PK "主键"
        TEXT setting_key UK "设置键名"
        TEXT setting_value "设置值"
        TEXT setting_type "值类型：string/integer/boolean/json"
        TEXT description "设置说明"
        DATETIME updated_at "设置更新时间"
    }

    %% 关系定义
    files ||--o{ file_content : "一个文件可以有多个内容记录"
    files ||--o{ search_history : "文件搜索会产生历史记录"
    ai_models ||--o{ search_history : "AI模型使用记录"

    %% 索引说明
    %% files表索引：
    %% PRIMARY KEY (id)
    %% UNIQUE KEY (file_path)
    %% INDEX (file_name)
    %% INDEX (file_type)
    %% INDEX (file_extension)
    %% INDEX (created_at)
    %% INDEX (modified_at)
    %% INDEX (indexed_at)
    %% INDEX (content_hash)
    %% INDEX (faiss_index_id)
    %% INDEX (whoosh_doc_id)

    %% search_history表索引：
    %% PRIMARY KEY (id)
    %% INDEX (search_query)
    %% INDEX (input_type)
    %% INDEX (search_type)
    %% INDEX (created_at)

    %% ai_models表索引：
    %% PRIMARY KEY (id)
    %% UNIQUE KEY (model_type, provider, model_name)
    %% INDEX (model_type)
    %% INDEX (provider)
    %% INDEX (is_active)

    %% index_jobs表索引：
    %% PRIMARY KEY (id)
    %% INDEX (folder_path)
    %% INDEX (job_type)
    %% INDEX (status)
    %% INDEX (started_at)

    %% file_content表索引：
    %% PRIMARY KEY (id)
    %% INDEX (file_id)
    %% INDEX (content_type)
    %% INDEX (created_at)

    %% app_settings表索引：
    %% PRIMARY KEY (id)
    %% UNIQUE KEY (setting_key)
```

#### 2.1.2 表结构详细设计

##### 2.2.1 files 文件索引表
存储所有已索引文件的基本信息和元数据。

| 字段名 | 数据类型 | 约束 | 说明 | 索引 |
|--------|----------|------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 主键，唯一标识文件 | PRIMARY |
| file_path | TEXT | UNIQUE NOT NULL | 文件绝对路径，用于去重和定位 | UNIQUE |
| file_name | TEXT | NOT NULL | 文件名（含扩展名） | INDEX |
| file_extension | TEXT | NOT NULL | 文件扩展名（如.pdf、.mp3） | INDEX |
| file_type | TEXT | NOT NULL | 文件类型：video/audio/document/image | INDEX |
| file_size | INTEGER | NOT NULL | 文件大小（字节） | |
| created_at | DATETIME | NOT NULL | 文件创建时间 | INDEX |
| modified_at | DATETIME | NOT NULL | 文件最后修改时间 | INDEX |
| indexed_at | DATETIME | NOT NULL | 索引建立时间 | INDEX |
| content_hash | TEXT | NOT NULL | 文件内容MD5哈希，用于变更检测 | INDEX |
| faiss_index_id | INTEGER | | 关联Faiss向量索引ID | INDEX |
| whoosh_doc_id | TEXT | | 关联Whoosh文档ID | INDEX |

#### 2.2.2 search_history 搜索历史表
记录用户搜索行为，用于优化搜索体验和统计分析。

| 字段名 | 数据类型 | 约束 | 说明 | 索引 |
|--------|----------|------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 主键，唯一标识搜索记录 | PRIMARY |
| search_query | TEXT | NOT NULL | 用户搜索查询内容 | INDEX |
| input_type | TEXT | NOT NULL | 输入类型：text/voice/image | INDEX |
| search_type | TEXT | NOT NULL | 搜索类型：semantic/fulltext/hybrid | INDEX |
| ai_model_used | TEXT | | 使用的AI模型名称 | |
| result_count | INTEGER | NOT NULL DEFAULT 0 | 搜索结果数量 | |
| response_time | REAL | NOT NULL | 响应时间（秒） | |
| created_at | DATETIME | NOT NULL DEFAULT CURRENT_TIMESTAMP | 搜索时间 | INDEX |

#### 2.2.3 ai_models AI模型配置表
管理AI模型的配置信息和状态。

| 字段名 | 数据类型 | 约束 | 说明 | 索引 |
|--------|----------|------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 主键，唯一标识模型配置 | PRIMARY |
| model_type | TEXT | NOT NULL | 模型类型：embedding/speech/vision/llm | INDEX |
| provider | TEXT | NOT NULL | 提供商类型：local/cloud | INDEX |
| model_name | TEXT | NOT NULL | 模型名称（如BGE-M3、faster-whisper） | |
| config_json | TEXT | NOT NULL | JSON格式的模型配置参数 | |
| is_active | BOOLEAN | DEFAULT TRUE | 是否启用该模型 | INDEX |
| created_at | DATETIME | NOT NULL DEFAULT CURRENT_TIMESTAMP | 配置创建时间 | |
| updated_at | DATETIME | NOT NULL DEFAULT CURRENT_TIMESTAMP | 配置更新时间 | |

#### 2.2.4 index_jobs 索引任务表
管理文件索引任务的执行状态和进度。

| 字段名 | 数据类型 | 约束 | 说明 | 索引 |
|--------|----------|------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 主键，唯一标识索引任务 | PRIMARY |
| folder_path | TEXT | NOT NULL | 索引目标文件夹路径 | INDEX |
| job_type | TEXT | NOT NULL | 任务类型：create/update/rebuild/delete | INDEX |
| status | TEXT | NOT NULL DEFAULT 'pending' | 任务状态：pending/processing/completed/failed | INDEX |
| total_files | INTEGER | DEFAULT 0 | 总文件数 | |
| processed_files | INTEGER | DEFAULT 0 | 已处理文件数 | |
| error_count | INTEGER | DEFAULT 0 | 处理失败文件数 | |
| started_at | DATETIME | | 任务开始时间 | |
| completed_at | DATETIME | | 任务完成时间 | |
| error_message | TEXT | | 错误信息 | |

#### 2.2.5 file_content 文件内容表（扩展）
存储文件提取的文本内容和元数据，支持增量更新。

| 字段名 | 数据类型 | 约束 | 说明 | 索引 |
|--------|----------|------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 主键，唯一标识内容记录 | PRIMARY |
| file_id | INTEGER | NOT NULL | 关联的文件ID | FOREIGN KEY |
| content_type | TEXT | NOT NULL | 内容类型：text/metadata/thumbnail | |
| content_text | TEXT | | 提取的文本内容（可长文本） | |
| metadata_json | TEXT | | 内容元数据（JSON格式） | |
| created_at | DATETIME | NOT NULL DEFAULT CURRENT_TIMESTAMP | 内容创建时间 | INDEX |

#### 2.2.6 app_settings 应用设置表
存储应用的全局配置设置。

| 字段名 | 数据类型 | 约束 | 说明 | 索引 |
|--------|----------|------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 主键 | PRIMARY |
| setting_key | TEXT | UNIQUE NOT NULL | 设置键名 | UNIQUE |
| setting_value | TEXT | | 设置值 | |
| setting_type | TEXT | NOT NULL | 值类型：string/integer/boolean/json | |
| description | TEXT | | 设置说明 | |
| updated_at | DATETIME | NOT NULL DEFAULT CURRENT_TIMESTAMP | 设置更新时间 | |

### 2.2 Faiss 向量索引设计

#### 2.2.1 索引结构
Faiss用于高效的向量相似度搜索，主要存储BGE-M3生成的文本嵌入向量。

| 参数 | 值 | 说明 |
|------|----| ----- |
| **向量维度** | 768 | BGE-M3模型生成的向量维度 |
| **索引类型** | IVF_PQ | 倒排索引 + 乘积量化 |
| **聚类数量** | 100 | IVF索引的聚类数量 |
| **PQ编码参数** | 32 | 乘积量化编码参数 |
| **探测数量** | 10 | 搜索时的探测数量 |

#### 2.2.2 存储结构
```
data/indexes/faiss/
├── document_index.faiss         # Faiss向量索引文件
├── metadata.pkl                # 向量元数据（pickle格式）
│   {
│       vector_id: {
│           "file_id": 1,
│           "chunk_text": "文档内容片段",
│           "chunk_index": 0,
│           "file_type": "document",
│           "embedding_model": "BGE-M3",
│           "created_at": "2025-01-01T00:00:00Z"
│       }
│   }
├── index_config.json            # 索引配置信息
│   {
│       "embedding_dim": 768,
│       "index_type": "IVF_PQ",
│       "nlist": 100,
│       "m": 32,
│       "model_name": "BAAI/bge-m3",
│       "created_at": "2025-01-01T00:00:00Z",
│       "total_vectors": 100000
│   }
└── id_mapping.json             # ID映射关系
    {
        "faiss_vector_id": 12345,
        "sqlite_file_id": 1,
        "chunk_index": 0
    }
```

#### 2.2.3 向量元数据表设计
虽然Faiss本身不使用传统表结构，但其元数据可通过以下结构化管理：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| **vector_id** | INTEGER | Faiss向量ID |
| **file_id** | INTEGER | 关联的SQLite文件ID |
| **chunk_index** | INTEGER | 文档分片索引 |
| **chunk_text** | TEXT | 文档分片内容 |
| **file_type** | TEXT | 文件类型 |
| **embedding_model** | TEXT | 使用的嵌入模型 |
| **created_at** | DATETIME | 向量创建时间 |

### 2.3 Whoosh 全文索引设计

#### 2.3.1 索引Schema设计
```python
from whoosh.fields import Schema, TEXT, ID, DATETIME, KEYWORD, NUMERIC
from whoosh.analysis import ChineseAnalyzer

# 中文分词器
chinese_analyzer = ChineseAnalyzer()

# Whoosh Schema定义
search_schema = Schema(
    # 文件基本信息
    file_id=ID(stored=True, unique=True),                    # 文件ID
    file_path=ID(stored=True),                               # 文件路径
    file_name=TEXT(stored=True, analyzer=chinese_analyzer),  # 文件名
    file_extension=ID(stored=True),                          # 文件扩展名
    file_type=KEYWORD(stored=True),                          # 文件类型

    # 内容信息
    title=TEXT(stored=True, analyzer=chinese_analyzer),      # 文档标题
    content=TEXT(stored=True, phrase=True, analyzer=chinese_analyzer),  # 文档内容
    tags=KEYWORD(stored=True, commas=True),                  # 标签
    description=TEXT(stored=True, analyzer=chinese_analyzer), # 描述

    # 元信息
    file_size=NUMERIC(stored=True),                          # 文件大小
    author=TEXT(stored=True, analyzer=chinese_analyzer),    # 作者
    language=KEYWORD(stored=True),                           # 语言

    # 时间信息
    created_at=DATETIME(stored=True),                        # 创建时间
    modified_at=DATETIME(stored=True),                       # 修改时间
    indexed_at=DATETIME(stored=True)                         # 索引时间
)
```

#### 2.3.2 存储结构
```
data/indexes/whoosh/
├── MAIN_0.seg                 # 主索引段
├── segments_0001             # 段信息
├── _toc.json                 # 索引目录
├── _per.doc                  # 文档数据
├── _stored_0.frj             # 存储字段数据
├── _fieldinfo_0.pym          # 字段信息
├── _locks/                   # 索引锁文件
└── index_config.json         # 索引配置
    {
        "analyzer": "ChineseAnalyzer",
        "created_at": "2025-01-01T00:00:00Z",
        "total_docs": 50000,
        "schema_version": "1.0"
    }
```

#### 2.3.3 全文索引字段表
Whoosh索引字段的详细设计：

| 字段名 | Whoosh类型 | 存储属性 | 分词器 | 说明 |
|--------|-----------|---------|--------|------|
| **file_id** | ID | stored=True | - | 唯一文件标识 |
| **file_path** | ID | stored=True | - | 文件路径 |
| **file_name** | TEXT | stored=True | ChineseAnalyzer | 文件名，支持中文搜索 |
| **file_extension** | ID | stored=True | - | 文件扩展名 |
| **file_type** | KEYWORD | stored=True | - | 文件类型 |
| **title** | TEXT | stored=True | ChineseAnalyzer | 文档标题 |
| **content** | TEXT | stored=True, phrase=True | ChineseAnalyzer | 文档正文内容 |
| **tags** | KEYWORD | stored=True, commas=True | - | 标签，支持多值 |
| **description** | TEXT | stored=True | ChineseAnalyzer | 文档描述 |
| **file_size** | NUMERIC | stored=True | - | 文件大小 |
| **author** | TEXT | stored=True | ChineseAnalyzer | 作者信息 |
| **language** | KEYWORD | stored=True | - | 文档语言 |
| **created_at** | DATETIME | stored=True | - | 创建时间 |
| **modified_at** | DATETIME | stored=True | - | 修改时间 |
| **indexed_at** | DATETIME | stored=True | - | 索引时间 |

---

**文档版本**: v1.0
**创建时间**: 2025年11月24日
**最后更新**: 2025年11月24日