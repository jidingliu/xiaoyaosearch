# 小遥搜索 - 索引构建逻辑文档

> 当前系统文件格式构建逻辑（MVP模式）

## 🔧 支持的文件类型（共16种）

> 根据配置文件 `config.py`，当前MVP模式支持以下文件格式：

### 📄 文档类（9种）
| 格式 | 功能描述 |
|------|----------|
| **PDF** (`.pdf`) | 文档内容提取 |
| **Word现代** (`.docx`) | Office现代格式文档内容提取 |
| **Word经典** (`.doc`) | Office经典格式文档内容提取 |
| **Excel现代** (`.xlsx`) | Office现代格式表格数据提取 |
| **Excel经典** (`.xls`) | Office经典格式表格数据提取 |
| **PowerPoint现代** (`.pptx`) | Office现代格式演示文稿内容提取 |
| **PowerPoint经典** (`.ppt`) | Office经典格式演示文稿内容提取 |
| **文本** (`.txt`) | 纯文本内容 |
| **Markdown** (`.md`) | 标记文档内容 |

### 🎵 音频类（2种）
| 格式 | 功能描述 | 特殊说明 |
|------|----------|----------|
| **MP3** (`.mp3`) | 语音转文字 + 元数据提取 | 15分钟时长限制 |
| **WAV** (`.wav`) | 语音转文字 + 元数据提取 | 15分钟时长限制 |

### 🎬 视频类（2种）
| 格式 | 功能描述 | 特殊说明 |
|------|----------|----------|
| **MP4** (`.mp4`) | 音频转录 + 元数据提取 | 15分钟时长限制 |
| **AVI** (`.avi`) | 音频转录 + 元数据提取 | 15分钟时长限制 |

### 🖼️ 图片类（2种）
| 格式 | 功能描述 | 特殊说明 |
|------|----------|----------|
| **PNG** (`.png`) | 图像理解 + 向量索引 | CLIP模型图像理解 |
| **JPEG** (`.jpg`, `.jpeg`) | 图像理解 + 向量索引 | CLIP模型图像理解 |
---

## 🔍 各格式的具体构建逻辑

### 📄 文档类（提取完整内容）

**构建流程：**

```mermaid
graph LR
    A[扫描识别] --> B[内容解析]
    B --> C[文本提取]
    C --> D[向量生成]
    D --> E[索引存储]
    E --> F[数据库记录]
```

1. **扫描识别** - 文件扫描器识别文件扩展名
2. **内容解析** - 内容解析器调用对应解析方法
3. **文本提取** - 提取完整文本内容（最大1MB）
4. **嵌入向量生成** - 使用BGE-M3生成1024维向量
5. **索引存储** - 同时存储到Faiss向量索引和Whoosh全文索引
6. **数据库记录** - 在 files 和 file_content 表创建记录

**输出示例：**
```javascript
{
  file_content: {
    content: "完整的文档文本内容",
    has_error: false,
    is_parsed: true
  }
}
```

---

### 📄 经典Office格式处理说明

**构建流程：**

```mermaid
graph LR
    A[格式识别] --> B[解析器选择]
    B --> C[工具检测]
    C --> D[内容提取]
    D --> E[语言检测]
    E --> F[向量生成]
    F --> G[索引存储]
```

**经典Word文档 (.doc)：**
1. **格式识别** - 通过文件扩展名识别经典Word格式
2. **工具检测** - 优先检测antiword工具是否可用
3. **内容提取** - 使用antiword提取文档文本内容
4. **降级处理** - antiword不可用时降级为元数据提取
5. **语言检测** - 自动检测中英文内容
6. **索引存储** - 生成向量索引和全文索引

**经典Excel (.xls) 和 PowerPoint (.ppt)：**
1. **兼容处理** - 使用现代Office库处理经典格式（有限支持）
2. **内容提取** - 提取表格数据或演示文稿文本
3. **降级提示** - 建议用户转换为现代格式获得更好支持
4. **元数据记录** - 详细记录处理状态和建议

**特殊说明：**
- 经典格式需要额外工具支持（如antiword）
- 处理成功时置信度为0.7-0.8
- 降级处理时置信度为0.3，并提供转换建议
- 所有处理失败都有详细的错误记录

---

### 🖼️ 图片类（图像理解 + 元数据）

**构建流程：**

```mermaid
graph LR
    A[扫描识别] --> B[图像理解]
    B --> C[特征提取]
    C --> D[向量生成]
    D --> E[索引存储]
    E --> F[数据库记录]
```

1. **扫描识别** - 识别图片文件扩展名
2. **图像理解** - 使用Chinese-CLIP模型理解图像内容
3. **特征提取** - 提取图像语义特征向量
4. **向量生成** - 生成图像理解描述文本
5. **索引存储** - 存储到Faiss向量索引
6. **数据库记录** - 在 files 和 file_content 表创建记录

**输出示例：**
```javascript
{
  file_content: {
    content: "这张图片展示了一座现代办公大楼，玻璃幕墙反射着阳光，建筑外观简洁时尚...",
    has_error: false,
    is_parsed: true,
    metadata: {
      "image_understood": true,
      "clip_confidence": 0.85,
      "file_size": 1024576
    }
  },
  files: {
    mime_type: "image/png"
  }
}
```

---

### 🎵 音频类（语音转文字 + 元数据）

**构建流程：**

```mermaid
graph LR
    A[扫描识别] --> B[时长检测]
    B --> C[时长控制]
    C --> D[语音转文字]
    D --> E[元数据解析]
    E --> F[向量生成]
    F --> G[索引存储]
    G --> H[数据库记录]
```

1. **扫描识别** - 识别音频文件扩展名
2. **时长检测** - 使用librosa获取音频时长
3. **时长控制** - 超过15分钟自动截取前15分钟内容
4. **语音转文字** - 使用FasterWhisper模型转录音频为文本
5. **元数据解析** - 使用mutagen提取音频元数据
6. **嵌入向量生成** - 使用转录文本生成向量
7. **索引存储** - 同时存储到Faiss向量索引和Whoosh全文索引
8. **数据库记录** - 在 files 和 file_content 表创建完整记录

**输出示例：**
```javascript
{
  file_content: {
    content: "这是音频转录的文本内容...",
    has_error: false,
    is_parsed: true,
    metadata: {
      "transcribed": true,
      "duration": 120.5,
      "truncated": false
    }
  },
  files: {
    mime_type: "audio/mpeg"
  }
}
```

---

### 🎬 视频类（音频转录 + 元数据）

**构建流程：**

```mermaid
graph LR
    A[扫描识别] --> B[时长检测]
    B --> C[时长控制]
    C --> D[音频提取]
    D --> E[语音转文字]
    E --> F[元数据解析]
    F --> G[向量生成]
    G --> H[索引存储]
    H --> I[数据库记录]
```

1. **扫描识别** - 识别视频文件扩展名
2. **时长检测** - 使用OpenCV获取视频时长和分辨率
3. **时长控制** - 超过15分钟自动截取前15分钟内容
4. **音频提取** - 使用ffmpeg从视频中提取音频轨道
5. **语音转文字** - 使用FasterWhisper模型转录音频为文本
6. **元数据解析** - 提取视频分辨率、帧率、编码等信息
7. **嵌入向量生成** - 使用转录文本生成向量
8. **索引存储** - 同时存储到Faiss向量索引和Whoosh全文索引
9. **数据库记录** - 在 files 和 file_content 表创建完整记录

**输出示例：**
```javascript
{
  file_content: {
    content: "这是视频音频转录的文本内容...",
    has_error: false,
    is_parsed: true,
    metadata: {
      "transcribed": true,
      "duration": 600.0,
      "resolution": "1920x1080",
      "truncated": true
    }
  },
  files: {
    mime_type: "video/mp4"
  }
}
```
---

---

## 🎯 总结

> 当前系统的构建逻辑采用分层设计：

| 文件类型 | 处理方式 | 特殊限制 |
|----------|----------|----------|
| **📄 文档类** | 完整内容提取 + 向量索引 | 支持现代和经典Office格式 |
| **🎵 音频类** | 语音转录 + 元数据提取 + 向量索引 | 15分钟时长限制 |
| **🎬 视频类** | 音频转录 + 元数据提取 + 向量索引 | 15分钟时长限制 |
| **🖼️ 图片类** | 图像理解 + 特征提取 + 向量索引 | CLIP模型处理 |
| **📦 其他格式** | 错误状态记录 + 向量索引 | 仅元数据记录 |

---

## 🎯 总结

> 当前系统的构建逻辑采用分层设计：

| 文件类型 | 处理方式 | 特殊限制 |
|----------|----------|----------|
| **📄 文档类** | 完整内容提取 + 向量索引 | 无特殊限制 |
| **🎵 音频类** | 语音转录 + 元数据提取 + 向量索引 | 15分钟时长限制 |
| **🎬 视频类** | 音频转录 + 元数据提取 + 向量索引 | 15分钟时长限制 |
| **🖼️ 图片类** | 错误状态记录 + 向量索引 | 暂不支持内容解析 |
| **📦 其他格式** | 错误状态记录 + 向量索引 | 仅元数据记录 |

---

## 🚀 核心功能特性

| 功能特性 | 技术实现 | 优势 |
|----------|----------|------|
| **🎤 音视频转录功能** | 使用FasterWhisper实现语音转文字 | 支持中文识别，准确率高 |
| **🖼️ 图像理解功能** | 使用Chinese-CLIP模型理解图像内容 | 支持中文图文理解，语义搜索 |
| **⏱️ 智能时长控制** | 超过15分钟自动截取前15分钟内容 | 确保系统性能，避免超时 |
| **📊 元数据完整性** | 详细记录文件信息、处理状态、置信度 | 提供完整的处理追踪 |
| **🛡️ 错误处理机制** | 处理失败时降级为元数据提取 | 确保即使失败也能创建索引 |
| **⚡ 异步处理架构** | 不阻塞主索引流程的后台处理 | 提升索引构建效率 |
| **🧹 资源自动清理** | 临时截取文件自动删除 | 避免磁盘空间浪费 |

---

## ✅ 设计优势

### 📈 性能与实用性
- **可搜索性** - 所有文件都可通过文件名和内容搜索
- **多模态搜索** - 支持文本、语音、图像的语义搜索
- **实用性** - 音视频提供转录文本，图片提供理解描述
- **性能控制** - 15分钟时长限制确保系统性能

### 🔒 稳定性与完整性
- **完整性** - 所有处理状态和元数据都被记录
- **扩展性** - 已实现CLIP图像理解，架构完整
- **稳定性** - 降级机制确保即使处理失败也能创建索引

### 🎯 技术先进性
- **AI模型集成** - BGE-M3文本嵌入 + FasterWhisper语音转文字 + Chinese-CLIP图像理解
- **中文优化** - 所有AI模型都针对中文进行优化
- **向量搜索** - 高效的语义相似度检索
- **实时处理** - 异步架构保证处理效率

---

---

> **最后更新时间**：2025年11月28日
> **文档版本**：v3.0 - 经典Office格式支持完整版

