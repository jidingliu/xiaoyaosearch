
<system-process>
## 核心系统流程

### 搜索引擎模块
模块职责
- 接收用户查询，解析查询意图
- 执行多路召回（向量检索 + 全文检索）
- 结果融合与重排序
- 生成摘要和高亮

核心流程
```markdown
用户输入查询
    ↓
┌──────────────────────────────────────┐
│ 1. 查询预处理                        │
│  - 文本清洗                          │
│  - 语言检测                          │
│  - 分词（中文）                      │
└──────────────────────────────────────┘
    ↓
┌──────────────────────────────────────┐
│ 2. LLM查询理解                       │
│  - 提取关键词                        │
│  - 识别时间范围（"上周""最近三天"） │
│  - 识别文件类型（"PPT""图片"）      │
│  - 生成语义化查询描述                │
└──────────────────────────────────────┘
    ↓
┌──────────────────────────────────────┐
│ 3. 查询向量化                        │
│  - 使用BGE模型生成查询向量           │
│  - 维度: 768                         │
└──────────────────────────────────────┘
    ↓
┌──────────────────────────────────────┐
│ 4. 多路召回                          │
│  ├─ 向量检索（Faiss）                │
│  │   - 余弦相似度搜索                │
│  │   - Top-K: 50                     │
│  │                                    │
│  └─ 全文检索（Whoosh）               │
│      - BM25算法                      │
│      - Top-K: 50                     │
└──────────────────────────────────────┘
    ↓
┌──────────────────────────────────────┐
│ 5. 结果融合（RRF算法）               │
│  - 向量检索权重: 0.6                 │
│  - 全文检索权重: 0.4                 │
│  - RRF公式: score = Σ(w/(k+rank))   │
│  - k = 60                            │
└──────────────────────────────────────┘
    ↓
┌──────────────────────────────────────┐
│ 6. 应用筛选条件                      │
│  - 文件类型筛选                      │
│  - 时间范围筛选                      │
│  - 文件大小筛选                      │
│  - 目录范围筛选                      │
└──────────────────────────────────────┘
    ↓
┌──────────────────────────────────────┐
│ 7. 结果后处理                        │
│  - 生成摘要（提取匹配上下文）        │
│  - 关键词高亮                        │
│  - 计算匹配度得分                    │
│  - 排序（相关度/时间/文件名）        │
└──────────────────────────────────────┘
    ↓
返回Top-20结果给用户
```
关键算法
RRF（Reciprocal Rank Fusion）算法:
- 用于融合多路召回结果
- 公式: score(d) = Σ weight_i / (k + rank_i(d))
- k通常取60
- 向量检索权重0.6，全文检索权重0.4
BM25算法:
- Whoosh全文检索使用
- 考虑词频（TF）和逆文档频率（IDF）
- 对文档长度进行归一化
余弦相似度:
- Faiss向量检索使用
- 计算查询向量和文档向量的余弦相似度
- 范围: [-1, 1]，值越大越相似

性能优化
查询缓存:
- 缓存最近100个查询结果
- LRU策略
- 缓存时间: 5分钟
查询改写:
- 同义词扩展
- 拼写纠错
- 查询简化
并行召回:
- 向量检索和全文检索并行执行
- 使用asyncio异步


### 索引管理模块

模块职责
- 扫描指定目录的文件
- 提取文件内容（文本/图片/音视频）
- 生成向量和全文索引
- 监控文件变化，增量更新索引

文件扫描流程
``` markdown
用户添加目录
    ↓
┌──────────────────────────────────────┐
│ 1. 目录验证                          │
│  - 检查目录是否存在                  │
│  - 检查读取权限                      │
│  - 检查是否已添加                    │
└──────────────────────────────────────┘
    ↓
┌──────────────────────────────────────┐
│ 2. 递归扫描目录                      │
│  - 遍历所有文件                      │
│  - 跳过隐藏文件（.开头）             │
│  - 跳过排除目录（node_modules等）    │
│  - 检查文件扩展名是否支持            │
│  - 检查文件大小是否超限              │
└──────────────────────────────────────┘
    ↓
┌──────────────────────────────────────┐
│ 3. 计算文件Hash                      │
│  - 使用MD5算法                       │
│  - 分块读取（避免大文件内存溢出）    │
│  - 用于检测文件是否变化              │
└──────────────────────────────────────┘
    ↓
┌──────────────────────────────────────┐
│ 4. 检查是否已索引                    │
│  - 查询数据库中的file_hash           │
│  - 如已索引且未修改，跳过            │
│  - 如已修改，删除旧索引              │
└──────────────────────────────────────┘
    ↓
进入文件处理流程
```

文件处理流程
```markdown
待处理文件
    ↓
┌──────────────────────────────────────┐
│ 1. 识别文件类型                      │
│  - 根据扩展名分类                    │
│  - 文档类: PDF, Word, Excel, PPT等   │
│  - 图片类: JPG, PNG等                │
│  - 音频类: MP3, WAV等                │
│  - 视频类: MP4, AVI等                │
└──────────────────────────────────────┘
    ↓
┌──────────────────────────────────────┐
│ 2. 内容提取（根据类型）              │
│                                      │
│  文档类:                             │
│  - PDF → Marker → Markdown → 文本   │
│  - Word/Excel/PPT → LibreOffice      │
│    → PDF → Marker → 文本            │
│  - TXT/MD → 直接读取                │
│                                      │
│  图片类:                             │
│  - PaddleOCR → 提取文字              │
│  - Chinese-CLIP → 生成标签           │
│  - 合并: OCR文字 + 标签              │
│                                      │
│  音频类:                             │
│  - Whisper → 语音转文字              │
│  - 提取元数据（时长、语言）          │
│                                      │
│  视频类:                             │
│  - FFmpeg提取音频 → Whisper转文字    │
│  - FFmpeg提取关键帧（15帧）          │
│  - Chinese-CLIP → 关键帧标签         │
│  - 合并: 转录文字 + 关键帧标签       │
└──────────────────────────────────────┘
    ↓
┌──────────────────────────────────────┐
│ 3. 文本向量化                        │
│  - 使用BGE模型                       │
│  - 输入: 提取的文本内容              │
│  - 输出: 768维向量                   │
└──────────────────────────────────────┘
    ↓
┌──────────────────────────────────────┐
│ 4. 存储索引                          │
│  - SQLite: 元数据（路径、大小、时间）│
│  - Faiss: 向量索引                   │
│  - Whoosh: 全文索引                  │
└──────────────────────────────────────┘
    ↓
索引完成，更新统计信息
```

文件监控机制
使用watchdog库监控文件系统变化:
```markdown
启动文件监控
    ↓
┌──────────────────────────────────────┐
│ 监听文件系统事件                      │
│  - 文件创建（on_created）            │
│  - 文件修改（on_modified）           │
│  - 文件删除（on_deleted）            │
│  - 文件移动（on_moved）              │
└──────────────────────────────────────┘
    ↓
┌──────────────────────────────────────┐
│ 事件去抖（Debounce）                 │
│  - 同一文件5秒内多次变化只处理一次   │
│  - 避免频繁触发索引                  │
└──────────────────────────────────────┘
    ↓
┌──────────────────────────────────────┐
│ 批量处理                             │
│  - 累积10个文件或等待10秒            │
│  - 批量更新索引                      │
│  - 提升效率                          │
└──────────────────────────────────────┘
    ↓
┌──────────────────────────────────────┐
│ 更新索引                             │
│  - 新增: 添加到索引                  │
│  - 修改: 删除旧索引，添加新索引      │
│  - 删除: 从索引中移除                │
└──────────────────────────────────────┘
    ↓
通过WebSocket通知前端
```

并发控制
批量处理:
- 每批10个文件
- 批内并发处理
- 避免内存溢出
并发限制:
- 最大并发数: 4
- 使用信号量控制
- 避免CPU/GPU过载
优先级队列:
- 用户主动触发的索引优先级高
- 文件监控触发的索引优先级低


### AI服务模块
LLM服务
职责:
- 解析查询意图
- 提取关键词和实体
- 生成摘要
实现方式:
- 本地模式: 调用Ollama API
- 云端模式: 调用OpenAI API
- 统一接口封装

提示词模板:
```markdown
系统提示词:
你是一个文件搜索助手，负责解析用户的搜索查询。

用户查询: {query}

请提取以下信息（JSON格式）:
1. keywords: 关键词列表
2. semantic_query: 语义化查询描述
3. time_range: 时间范围 {start_date, end_date}
4. file_types: 文件类型列表

示例:
输入: "上周的产品设计PPT"
输出: {
  "keywords": ["产品设计", "PPT"],
  "semantic_query": "产品设计相关的演示文稿",
  "time_range": {"start_date": "2024-10-24", "end_date": "2024-10-31"},
  "file_types": ["ppt", "pptx"]
}
```

Embedding服务
职责:
- 文本向量化
- 查询向量化
实现方式:
- 加载BGE模型
- 批量处理提升效率
- GPU加速（如果可用）
优化策略:
- 模型预加载
- 批量编码（batch_size=32）
- 向量归一化
- 缓存常用查询向量


ASR服务
职责:
- 语音转文字
- 音频文件转录
实现方式:
- 加载Whisper模型
- 支持多种音频格式
- 自动语言检测
处理流程:
```markdown
音频输入
    ↓
音频预处理
 - 转换为16kHz单声道WAV
 - 使用FFmpeg
    ↓
Whisper转录
 - 自动检测语言
 - 生成时间戳
 - 输出文本和元数据
    ↓
返回结果
 - text: 转录文本
 - language: 检测到的语言
 - segments: 带时间戳的片段

```
优化策略:
- 音频分段处理（30秒一段）
- GPU加速
- 模型大小动态选择

视觉服务
职责:
- 图片理解和标签生成
- 视频关键帧分析
实现方式:
- Chinese-CLIP模型
- 预定义标签库（1000+常用标签）
- 相似度匹配
标签生成流程:
```markdown
图片输入
    ↓
图片预处理
 - 调整大小（224x224）
 - 归一化
    ↓
Chinese-CLIP编码
 - 生成图片向量
    ↓
与标签库匹配
 - 计算相似度
 - Top-10标签
 - 阈值过滤（>0.3）
    ↓
返回标签列表
```

### 文件管理模块
文件操作
支持的操作:
- 打开文件（用默认应用）
- 打开所在目录（在文件管理器中定位）
- 复制文件路径
- 删除文件（需确认）
- 重命名文件
- 移动文件
实现方式:
- 使用Node.js fs模块
- 调用系统命令
- 权限检查

文件预览
支持的文件类型:
- 文档: PDF, TXT, Markdown
- 图片: JPG, PNG, GIF
- 视频: MP4, AVI（内嵌播放器）
- 音频: MP3, WAV（内嵌播放器）
实现方式:
- PDF: 使用pdf.js渲染
- 图片: 直接显示
- 视频/音频: HTML5 video/audio标签
- 文本: 代码高亮显示
特殊功能:
- 视频/音频跳转到匹配时间点
- 显示转录字幕
- 关键帧导航


</system-process>