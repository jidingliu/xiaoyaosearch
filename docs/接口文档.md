# 小遥搜索 (XiaoyaoSearch) API 接口文档

## 目录
1. [接口概述](#1-接口概述)
2. [认证和错误处理](#2-认证和错误处理)
3. [数据模型](#3-数据模型)
4. [搜索服务API](#4-搜索服务api)
5. [索引管理API](#5-索引管理api)
6. [AI模型配置API](#6-ai模型配置api)
7. [系统管理API](#7-系统管理api)
8. [WebSocket接口](#8-websocket接口)
9. [前端集成示例](#9-前端集成示例)
10. [错误码参考](#10-错误码参考)

## 1. 接口概述

### 基本信息
- **接口版本**: v1.0.0
- **基础URL**: `http://127.0.0.1:8000`
- **认证方式**: 本地应用，无需认证
- **数据格式**: JSON
- **字符编码**: UTF-8

### 交互式文档
- **Swagger UI**: `http://127.0.0.1:8000/docs`
- **ReDoc**: `http://127.0.0.1:8000/redoc`

### 技术栈
- **后端框架**: FastAPI + Uvicorn
- **数据验证**: Pydantic v2
- **异步支持**: asyncio
- **CORS**: 支持Electron跨域访问

## 2. 认证和错误处理

### 认证机制
```http
# 本地应用无需认证，支持Electron渲染进程访问
Origin: http://localhost:3000
```

### 统一错误响应格式
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "请求参数验证失败",
    "details": "query字段不能为空"
  }
}
```

### HTTP状态码规范
| 状态码 | 说明 | 使用场景 |
|--------|------|----------|
| 200 | 成功 | 请求处理成功 |
| 400 | 请求错误 | 参数验证失败、格式错误 |
| 404 | 资源不存在 | 索引任务、模型配置不存在 |
| 413 | 文件过大 | 上传文件超过50MB限制 |
| 500 | 服务器错误 | 内部异常、AI模型加载失败 |

## 3. 数据模型

### 枚举类型
```typescript
// 输入类型
enum InputType {
  TEXT = "text",
  VOICE = "voice",
  IMAGE = "image"
}

// 搜索类型
enum SearchType {
  SEMANTIC = "semantic",    // 语义搜索
  FULLTEXT = "fulltext",    // 全文搜索
  HYBRID = "hybrid"         // 混合搜索
}

// 文件类型
enum FileType {
  VIDEO = "video",
  AUDIO = "audio",
  DOCUMENT = "document",
  IMAGE = "image"
}
```

### 核心数据模型
```typescript
// 搜索请求
interface SearchRequest {
  query: string;                    // 搜索查询词 (1-500字符)
  input_type?: InputType;           // 输入类型，默认TEXT
  search_type?: SearchType;         // 搜索类型，默认HYBRID
  limit?: number;                   // 返回结果数量 (1-100)，默认20
  threshold?: number;               // 相似度阈值 (0.0-1.0)，默认0.7
  file_types?: FileType[];          // 文件类型过滤
}

// 多模态请求
interface MultimodalRequest {
  input_data: string;               // Base64编码的文件数据
  input_type: InputType;            // 输入类型voice或image
  duration?: number;                // 音频最长时长秒数 (1-120)，默认30
}

// 索引创建请求
interface IndexCreateRequest {
  folder_path: string;              // 索引文件夹路径
  file_types?: string[];            // 支持文件类型
  recursive?: boolean;              // 是否递归搜索子文件夹
}

// AI模型配置请求
interface AIModelConfigRequest {
  model_type: string;               // 模型类型 embedding/speech/vision/llm
  provider: string;                 // 提供商类型 local/cloud
  model_name: string;               // 模型名称 (1-100字符)
  config: Record<string, any>;      // 模型配置参数
}

// 搜索结果
interface SearchResult {
  file_id: number;
  file_name: string;
  file_path: string;
  file_type: FileType;
  relevance_score: number;          // 相关性分数 (0.0-1.0)
  preview_text: string;             // 预览文本 (最多200字符)
  highlight: string;                // 高亮片段
  created_at: string;               // 文件创建时间
  modified_at: string;              // 文件修改时间
  file_size: number;                // 文件大小(字节)
  match_type: string;               // 匹配类型 semantic/fulltext/hybrid
}

// 统一响应格式
interface SearchResponse {
  success: boolean;
  data: {
    results: SearchResult[];
    total: number;
    search_time: number;            // 搜索耗时(秒)
    query_used: string;             // 实际使用的查询词
    input_processed: boolean;       // 是否进行了输入预处理
  };
  message?: string;
}

interface MultimodalResponse {
  success: boolean;
  data: {
    converted_text: string;         // 转换后的文本
    confidence: number;             // 转换置信度
    search_results: SearchResult[];
    file_info: {
      filename: string;
      size: number;
      content_type: string;
    };
  };
  message?: string;
}
```

## 4. 搜索服务API

### 4.1 文本搜索
```http
POST /api/search
Content-Type: application/json
```

**请求参数**
```json
{
  "query": "人工智能发展趋势",
  "input_type": "text",
  "search_type": "hybrid",
  "limit": 20,
  "threshold": 0.7,
  "file_types": ["document", "pdf"]
}
```

**响应示例**
```json
{
  "success": true,
  "data": {
    "results": [
      {
        "file_id": 1,
        "file_name": "AI发展报告.pdf",
        "file_path": "/Users/Downloads/AI发展报告.pdf",
        "file_type": "document",
        "relevance_score": 0.92,
        "preview_text": "人工智能技术在过去几年中取得了突破性进展...",
        "highlight": "人工智能技术在过去几年中取得了<em>突破性进展</em>",
        "created_at": "2024-01-15T10:30:00Z",
        "modified_at": "2024-01-15T10:30:00Z",
        "file_size": 2048576,
        "match_type": "hybrid"
      }
    ],
    "total": 1,
    "search_time": 0.15,
    "query_used": "人工智能发展趋势",
    "input_processed": false
  }
}
```

### 4.2 多模态搜索
```http
POST /api/search/multimodal
Content-Type: multipart/form-data
```

**表单参数**
- `input_type`: 输入类型 (voice/image)
- `file`: 上传的文件 (最大50MB)

**支持的文件格式**
- **语音**: mp3, wav, m4a, flac (最大120秒)
- **图像**: jpg, jpeg, png, webp (最大10MB)

**响应示例**
```json
{
  "success": true,
  "data": {
    "converted_text": "请帮我找一些关于机器学习的资料",
    "confidence": 0.95,
    "search_results": [
      {
        "file_id": 2,
        "file_name": "机器学习入门.docx",
        "file_path": "/Documents/机器学习入门.docx",
        "file_type": "document",
        "relevance_score": 0.88,
        "preview_text": "机器学习是人工智能的一个重要分支...",
        "highlight": "机器学习是人工智能的一个重要分支",
        "created_at": "2024-01-10T09:20:00Z",
        "modified_at": "2024-01-10T09:20:00Z",
        "file_size": 1024576,
        "match_type": "semantic"
      }
    ],
    "file_info": {
      "filename": "recording.wav",
      "size": 1024000,
      "content_type": "audio/wav"
    }
  }
}
```

### 4.3 搜索历史
```http
GET /api/search/history?limit=20&offset=0
```

**查询参数**
- `limit`: 返回数量 (1-100)
- `offset`: 偏移量

**响应示例**
```json
{
  "success": true,
  "data": {
    "history": [
      {
        "id": 1,
        "search_query": "人工智能发展趋势",
        "input_type": "text",
        "search_type": "hybrid",
        "ai_model_used": "bge-m3",
        "result_count": 5,
        "response_time": 0.15,
        "created_at": "2024-01-20T14:30:00Z"
      }
    ],
    "total": 1
  }
}
```

## 5. 索引管理API

### 5.1 创建索引
```http
POST /api/index/create
Content-Type: application/json
```

**请求参数**
```json
{
  "folder_path": "/Users/Documents",
  "file_types": ["pdf", "txt", "md", "docx", "xlsx", "mp3", "mp4", "wav"],
  "recursive": true
}
```

**响应示例**
```json
{
  "success": true,
  "data": {
    "index_id": 1,
    "status": "processing",
    "message": "索引任务已创建并开始执行"
  }
}
```

### 5.2 查询索引状态
```http
GET /api/index/status/{index_id}
```

**路径参数**
- `index_id`: 索引任务ID

**响应示例**
```json
{
  "success": true,
  "data": {
    "index_id": 1,
    "folder_path": "/Users/Documents",
    "status": "processing",
    "progress": 45,
    "total_files": 100,
    "processed_files": 45,
    "error_count": 2,
    "started_at": "2024-01-20T10:00:00Z",
    "completed_at": null,
    "error_message": null
  }
}
```

### 5.3 删除索引
```http
DELETE /api/index/{index_id}
```

**响应示例**
```json
{
  "success": true,
  "message": "索引删除成功"
}
```

### 5.4 索引列表
```http
GET /api/index/list?status=completed&limit=10
```

**查询参数**
- `status`: 任务状态过滤 (pending/processing/completed/failed)
- `limit`: 返回数量

**响应示例**
```json
{
  "success": true,
  "data": {
    "indexes": [
      {
        "id": 1,
        "folder_path": "/Users/Documents",
        "status": "completed",
        "total_files": 100,
        "processed_files": 98,
        "error_count": 2,
        "created_at": "2024-01-20T10:00:00Z",
        "completed_at": "2024-01-20T10:15:00Z"
      }
    ],
    "total": 1
  }
}
```

## 6. AI模型配置API

### 6.1 更新AI模型配置
```http
POST /api/config/ai-model
Content-Type: application/json
```

**请求参数**
```json
{
  "model_type": "embedding",
  "provider": "local",
  "model_name": "bge-m3",
  "config": {
    "model_path": "/models/bge-m3",
    "device": "cpu",
    "embedding_dim": 768,
    "max_length": 8192
  }
}
```

**响应示例**
```json
{
  "success": true,
  "message": "AI模型配置更新成功"
}
```

### 6.2 获取所有AI模型配置
```http
GET /api/config/ai-models
```

**响应示例**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "model_type": "embedding",
      "provider": "local",
      "model_name": "bge-m3",
      "config_json": "{\"model_path\": \"/models/bge-m3\", \"device\": \"cpu\"}",
      "is_active": true,
      "created_at": "2024-01-15T08:00:00Z",
      "updated_at": "2024-01-15T08:00:00Z"
    },
    {
      "id": 2,
      "model_type": "speech",
      "provider": "cloud",
      "model_name": "aliyun-asr",
      "config_json": "{\"api_key\": \"***\", \"endpoint\": \"https://nls-gateway.cn-shanghai.aliyuncs.com\"}",
      "is_active": false,
      "created_at": "2024-01-15T08:30:00Z",
      "updated_at": "2024-01-15T08:30:00Z"
    }
  ]
}
```

### 6.3 测试AI模型
```http
POST /api/config/ai-model/{model_id}/test
```

**路径参数**
- `model_id`: 模型配置ID

**响应示例**
```json
{
  "success": true,
  "data": {
    "model_id": 1,
    "test_passed": true,
    "response_time": 0.12,
    "test_message": "BGE-M3模型测试成功，响应时间：120ms"
  }
}
```

## 7. 系统管理API

### 7.1 获取应用设置
```http
GET /api/settings
```

**响应示例**
```json
{
  "success": true,
  "data": {
    "app_name": "小遥搜索",
    "version": "1.0.0",
    "search": {
      "default_limit": 20,
      "default_threshold": 0.7,
      "max_file_size": 52428800
    },
    "indexing": {
      "max_concurrent_jobs": 3,
      "supported_formats": ["pdf", "txt", "md", "docx", "xlsx", "mp3", "mp4", "wav"],
      "auto_rebuild": false
    },
    "ui": {
      "theme": "light",
      "language": "zh-CN"
    }
  }
}
```

### 7.2 更新应用设置
```http
POST /api/settings
Content-Type: application/json
```

**请求参数**
```json
{
  "search": {
    "default_limit": 30,
    "default_threshold": 0.75
  },
  "ui": {
    "theme": "dark"
  }
}
```

**响应示例**
```json
{
  "success": true,
  "message": "设置更新成功"
}
```

### 7.3 系统健康检查
```http
GET /api/system/health
```

**响应示例**
```json
{
  "success": true,
  "data": {
    "status": "healthy",
    "database": {
      "status": "connected",
      "response_time": 0.002
    },
    "ai_models": {
      "bge_m3": {
        "status": "loaded",
        "memory_usage": "2.1GB"
      },
      "faster_whisper": {
        "status": "not_loaded",
        "error": null
      }
    },
    "indexes": {
      "faiss_index": {
        "status": "ready",
        "document_count": 15420
      },
      "whoosh_index": {
        "status": "ready",
        "document_count": 15420
      }
    },
    "timestamp": "2024-01-20T15:30:00Z"
  }
}
```

## 8. WebSocket接口

### 8.1 索引进度实时推送
```javascript
// 连接WebSocket
const ws = new WebSocket('ws://127.0.0.1:8000/ws/index/{index_id}');

// 接收消息格式
{
  "type": "progress_update",
  "data": {
    "index_id": 1,
    "status": "processing",
    "progress": 75,
    "processed_files": 75,
    "total_files": 100,
    "current_file": "/Users/Documents/report.pdf"
  }
}

{
  "type": "completed",
  "data": {
    "index_id": 1,
    "status": "completed",
    "progress": 100,
    "processed_files": 98,
    "total_files": 100,
    "error_count": 2,
    "completed_at": "2024-01-20T10:15:00Z"
  }
}
```

### 8.2 搜索建议推送
```javascript
// 连接搜索建议WebSocket
const ws = new WebSocket('ws://127.0.0.1:8000/ws/search-suggest');

// 发送查询
ws.send(JSON.stringify({
  "query": "人工智",
  "limit": 5
}));

// 接收建议
{
  "type": "suggestions",
  "data": {
    "suggestions": [
      "人工智能",
      "人工智能技术",
      "人工智能发展趋势",
      "人工智能应用",
      "人工智能算法"
    ]
  }
}
```

## 9. 前端集成示例

### 9.1 Axios配置
```typescript
// api/config.ts
import axios from 'axios';

const api = axios.create({
  baseURL: 'http://127.0.0.1:8000',
  timeout: 30000,
  headers: {
    'Content-Type': 'application/json'
  }
});

// 响应拦截器
api.interceptors.response.use(
  response => response.data,
  error => {
    console.error('API Error:', error.response?.data || error.message);
    return Promise.reject(error);
  }
);

export default api;
```

### 9.2 搜索服务封装
```typescript
// api/search.ts
import api from './config';

export interface SearchParams {
  query: string;
  input_type?: 'text' | 'voice' | 'image';
  search_type?: 'semantic' | 'fulltext' | 'hybrid';
  limit?: number;
  threshold?: number;
  file_types?: string[];
}

export class SearchService {
  // 文本搜索
  static async search(params: SearchParams) {
    return await api.post('/api/search', params);
  }

  // 多模态搜索
  static async multimodalSearch(inputType: 'voice' | 'image', file: File) {
    const formData = new FormData();
    formData.append('input_type', inputType);
    formData.append('file', file);

    return await api.post('/api/search/multimodal', formData, {
      headers: {
        'Content-Type': 'multipart/form-data'
      }
    });
  }

  // 搜索历史
  static async getHistory(limit = 20, offset = 0) {
    return await api.get(`/api/search/history?limit=${limit}&offset=${offset}`);
  }
}
```

### 9.3 索引管理封装
```typescript
// api/index.ts
import api from './config';

export class IndexService {
  // 创建索引
  static async createIndex(params: {
    folder_path: string;
    file_types?: string[];
    recursive?: boolean;
  }) {
    return await api.post('/api/index/create', params);
  }

  // 获取索引状态
  static async getIndexStatus(indexId: number) {
    return await api.get(`/api/index/status/${indexId}`);
  }

  // 删除索引
  static async deleteIndex(indexId: number) {
    return await api.delete(`/api/index/${indexId}`);
  }

  // 索引列表
  static async getIndexList(status?: string, limit = 10) {
    const params = new URLSearchParams();
    if (status) params.append('status', status);
    params.append('limit', limit.toString());

    return await api.get(`/api/index/list?${params.toString()}`);
  }
}
```

### 9.4 Vue组件示例
```vue
<!-- components/SearchInterface.vue -->
<template>
  <div class="search-interface">
    <!-- 搜索输入 -->
    <a-input-search
      v-model:value="searchQuery"
      placeholder="输入搜索内容..."
      size="large"
      @search="handleSearch"
      :loading="searching"
    />

    <!-- 多模态输入 -->
    <div class="multimodal-input">
      <a-upload
        :before-upload="handleMultimodalUpload"
        :show-upload-list="false"
        accept=".mp3,.wav,.jpg,.jpeg,.png"
      >
        <a-button type="primary" ghost>
          <CameraOutlined v-if="inputType === 'image'" />
          <AudioOutlined v-else />
          {{ inputType === 'image' ? '图片搜索' : '语音搜索' }}
        </a-button>
      </a-upload>
    </div>

    <!-- 搜索结果 -->
    <div class="search-results" v-if="results.length > 0">
      <a-list
        :data-source="results"
        item-layout="vertical"
        size="large"
      >
        <template #renderItem="{ item }">
          <a-list-item>
            <a-list-item-meta>
              <template #title>
                <a @click="openFile(item.file_path)">{{ item.file_name }}</a>
              </template>
              <template #description>
                <a-tag :color="getFileTypeColor(item.file_type)">
                  {{ item.file_type }}
                </a-tag>
                <span class="relevance-score">
                  相关性: {{ (item.relevance_score * 100).toFixed(1) }}%
                </span>
              </template>
            </a-list-item-meta>
            <div class="preview-text" v-html="item.highlight"></div>
          </a-list-item>
        </template>
      </a-list>
    </div>
  </div>
</template>

<script lang="ts" setup>
import { ref, reactive } from 'vue';
import { message } from 'ant-design-vue';
import { SearchService } from '@/api/search';
import type { SearchResult } from '@/types/api';

const searchQuery = ref('');
const searching = ref(false);
const inputType = ref<'voice' | 'image'>('image');
const results = ref<SearchResult[]>([]);

const handleSearch = async () => {
  if (!searchQuery.value.trim()) {
    message.warning('请输入搜索内容');
    return;
  }

  searching.value = true;
  try {
    const response = await SearchService.search({
      query: searchQuery.value,
      search_type: 'hybrid',
      limit: 20
    });

    if (response.success) {
      results.value = response.data.results;
      message.success(`找到 ${response.data.total} 个相关文件`);
    }
  } catch (error) {
    message.error('搜索失败，请重试');
    console.error('Search error:', error);
  } finally {
    searching.value = false;
  }
};

const handleMultimodalUpload = async (file: File) => {
  const isImage = file.type.startsWith('image/');
  inputType.value = isImage ? 'image' : 'voice';

  try {
    const response = await SearchService.multimodalSearch(inputType.value, file);

    if (response.success) {
      results.value = response.data.search_results;
      message.success(`语音识别: "${response.data.converted_text}"`);
    }
  } catch (error) {
    message.error('多模态搜索失败');
    console.error('Multimodal search error:', error);
  }

  return false; // 阻止默认上传行为
};

const openFile = (filePath: string) => {
  // 打开文件的逻辑
  window.api.openFile(filePath);
};

const getFileTypeColor = (type: string) => {
  const colors = {
    document: 'blue',
    image: 'green',
    audio: 'orange',
    video: 'red'
  };
  return colors[type] || 'default';
};
</script>
```

## 10. 错误码参考

### 10.1 通用错误码
| 错误码 | HTTP状态码 | 说明 |
|--------|------------|------|
| SUCCESS | 200 | 操作成功 |
| VALIDATION_ERROR | 400 | 请求参数验证失败 |
| UNAUTHORIZED | 401 | 未授权访问 |
| FORBIDDEN | 403 | 禁止访问 |
| NOT_FOUND | 404 | 资源不存在 |
| METHOD_NOT_ALLOWED | 405 | 请求方法不允许 |
| PAYLOAD_TOO_LARGE | 413 | 请求体过大 |
| UNSUPPORTED_MEDIA_TYPE | 415 | 不支持的媒体类型 |
| RATE_LIMIT_EXCEEDED | 429 | 请求频率超限 |
| INTERNAL_ERROR | 500 | 服务器内部错误 |
| SERVICE_UNAVAILABLE | 503 | 服务不可用 |

### 10.2 业务错误码
| 错误码 | 说明 | 解决方案 |
|--------|------|----------|
| SEARCH_QUERY_EMPTY | 搜索查询不能为空 | 检查query参数 |
| SEARCH_THRESHOLD_INVALID | 相似度阈值超出范围 | 使用0.0-1.0之间的值 |
| FILE_TOO_LARGE | 文件大小超过限制 | 压缩文件或分割上传 |
| UNSUPPORTED_FILE_TYPE | 不支持的文件类型 | 使用支持的文件格式 |
| FOLDER_NOT_FOUND | 文件夹不存在 | 检查folder_path参数 |
| INDEX_JOB_RUNNING | 索引任务正在运行 | 等待当前任务完成或取消 |
| MODEL_NOT_FOUND | AI模型配置不存在 | 检查model_id或创建新配置 |
| MODEL_LOAD_FAILED | AI模型加载失败 | 检查模型路径和依赖环境 |
| DATABASE_CONNECTION_FAILED | 数据库连接失败 | 检查数据库文件权限 |
| INSUFFICIENT_MEMORY | 内存不足 | 释放内存或增加系统内存 |

### 10.3 错误处理最佳实践
```typescript
// 统一错误处理函数
const handleApiError = (error: any) => {
  if (error.response) {
    const { status, data } = error.response;

    switch (status) {
      case 400:
        message.error(data.error?.details || '请求参数错误');
        break;
      case 404:
        message.error('请求的资源不存在');
        break;
      case 413:
        message.error('文件大小超过限制（50MB）');
        break;
      case 500:
        message.error('服务器内部错误，请稍后重试');
        break;
      default:
        message.error(`请求失败 (${status})`);
    }
  } else if (error.request) {
    message.error('网络连接失败，请检查后端服务');
  } else {
    message.error('请求配置错误');
  }
};

// 使用示例
try {
  const response = await SearchService.search(params);
  // 处理成功响应
} catch (error) {
  handleApiError(error);
}
```

---

## 更新日志

### v1.0.0 (2024-01-20)
- 初始版本发布
- 完整的搜索、索引、配置管理API
- 多模态搜索支持
- WebSocket实时通信
- 前端集成示例

---

**维护团队**: 小遥搜索开发组
**技术支持**: [GitHub Issues](https://github.com/your-repo/issues)
**文档更新**: 2024-01-20