# å°é¥æœç´¢ (XiaoyaoSearch) API æ¥å£æ–‡æ¡£

## ç›®å½•
1. [æ¥å£æ¦‚è¿°](#1-æ¥å£æ¦‚è¿°)
2. [è®¤è¯å’Œé”™è¯¯å¤„ç†](#2-è®¤è¯å’Œé”™è¯¯å¤„ç†)
3. [æ•°æ®æ¨¡å‹](#3-æ•°æ®æ¨¡å‹)
4. [æœç´¢æœåŠ¡API](#4-æœç´¢æœåŠ¡api)
5. [ç´¢å¼•ç®¡ç†API](#5-ç´¢å¼•ç®¡ç†api)
6. [AIæ¨¡å‹é…ç½®API](#6-aiæ¨¡å‹é…ç½®api)
7. [ç³»ç»Ÿç®¡ç†API](#7-ç³»ç»Ÿç®¡ç†api)
8. [åº”ç”¨æ—¥å¿—API](#8-åº”ç”¨æ—¥å¿—api)
9. [WebSocketæ¥å£](#9-websocketæ¥å£)
10. [å‰ç«¯é›†æˆç¤ºä¾‹](#10-å‰ç«¯é›†æˆç¤ºä¾‹)
11. [é”™è¯¯ç å‚è€ƒ](#11-é”™è¯¯ç å‚è€ƒ)

## 1. æ¥å£æ¦‚è¿°

### åŸºæœ¬ä¿¡æ¯
- **æ¥å£ç‰ˆæœ¬**: v1.0.0
- **åŸºç¡€URL**: `http://127.0.0.1:8000`
- **è®¤è¯æ–¹å¼**: æœ¬åœ°åº”ç”¨ï¼Œæ— éœ€è®¤è¯
- **æ•°æ®æ ¼å¼**: JSON
- **å­—ç¬¦ç¼–ç **: UTF-8

### äº¤äº’å¼æ–‡æ¡£
- **Swagger UI**: `http://127.0.0.1:8000/docs`
- **ReDoc**: `http://127.0.0.1:8000/redoc`

### æŠ€æœ¯æ ˆ
- **åç«¯æ¡†æ¶**: FastAPI + Uvicorn
- **æ•°æ®éªŒè¯**: Pydantic v2
- **å¼‚æ­¥æ”¯æŒ**: asyncio
- **CORS**: æ”¯æŒElectronè·¨åŸŸè®¿é—®

## 2. è®¤è¯å’Œé”™è¯¯å¤„ç†

### è®¤è¯æœºåˆ¶
```http
# æœ¬åœ°åº”ç”¨æ— éœ€è®¤è¯ï¼Œæ”¯æŒElectronæ¸²æŸ“è¿›ç¨‹è®¿é—®
Origin: http://localhost:3000
```

### ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "è¯·æ±‚å‚æ•°éªŒè¯å¤±è´¥",
    "details": "queryå­—æ®µä¸èƒ½ä¸ºç©º"
  }
}
```

### HTTPçŠ¶æ€ç è§„èŒƒ
| çŠ¶æ€ç  | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|--------|------|----------|
| 200 | æˆåŠŸ | è¯·æ±‚å¤„ç†æˆåŠŸ |
| 400 | è¯·æ±‚é”™è¯¯ | å‚æ•°éªŒè¯å¤±è´¥ã€æ ¼å¼é”™è¯¯ |
| 404 | èµ„æºä¸å­˜åœ¨ | ç´¢å¼•ä»»åŠ¡ã€æ¨¡å‹é…ç½®ä¸å­˜åœ¨ |
| 413 | æ–‡ä»¶è¿‡å¤§ | ä¸Šä¼ æ–‡ä»¶è¶…è¿‡50MBé™åˆ¶ |
| 500 | æœåŠ¡å™¨é”™è¯¯ | å†…éƒ¨å¼‚å¸¸ã€AIæ¨¡å‹åŠ è½½å¤±è´¥ |

## 3. æ•°æ®æ¨¡å‹

### æšä¸¾ç±»å‹
```typescript
// è¾“å…¥ç±»å‹
enum InputType {
  TEXT = "text",
  VOICE = "voice",
  IMAGE = "image"
}

// æœç´¢ç±»å‹
enum SearchType {
  SEMANTIC = "semantic",    // è¯­ä¹‰æœç´¢
  FULLTEXT = "fulltext",    // å…¨æ–‡æœç´¢
  HYBRID = "hybrid"         // æ··åˆæœç´¢
}

// æ–‡ä»¶ç±»å‹
enum FileType {
  VIDEO = "video",
  AUDIO = "audio",
  DOCUMENT = "document",
  IMAGE = "image"
}
```

### æ ¸å¿ƒæ•°æ®æ¨¡å‹
```typescript
// æœç´¢è¯·æ±‚
interface SearchRequest {
  query: string;                    // æœç´¢æŸ¥è¯¢è¯ (1-500å­—ç¬¦)
  input_type?: InputType;           // è¾“å…¥ç±»å‹ï¼Œé»˜è®¤TEXT
  search_type?: SearchType;         // æœç´¢ç±»å‹ï¼Œé»˜è®¤HYBRID
  limit?: number;                   // è¿”å›ç»“æœæ•°é‡ (1-100)ï¼Œé»˜è®¤20
  threshold?: number;               // ç›¸ä¼¼åº¦é˜ˆå€¼ (0.0-1.0)ï¼Œé»˜è®¤0.7
  file_types?: FileType[];          // æ–‡ä»¶ç±»å‹è¿‡æ»¤
}

// å¤šæ¨¡æ€è¯·æ±‚
interface MultimodalRequest {
  input_data: string;               // Base64ç¼–ç çš„æ–‡ä»¶æ•°æ®
  input_type: InputType;            // è¾“å…¥ç±»å‹voiceæˆ–image
  duration?: number;                // éŸ³é¢‘æœ€é•¿æ—¶é•¿ç§’æ•° (1-120)ï¼Œé»˜è®¤30
}

// ç´¢å¼•åˆ›å»ºè¯·æ±‚
interface IndexCreateRequest {
  folder_path: string;              // ç´¢å¼•æ–‡ä»¶å¤¹è·¯å¾„
  file_types?: string[];            // æ”¯æŒæ–‡ä»¶ç±»å‹
  recursive?: boolean;              // æ˜¯å¦é€’å½’æœç´¢å­æ–‡ä»¶å¤¹
}

// AIæ¨¡å‹é…ç½®è¯·æ±‚
interface AIModelConfigRequest {
  model_type: string;               // æ¨¡å‹ç±»å‹ embedding/speech/vision/llm
  provider: string;                 // æä¾›å•†ç±»å‹ local/cloud
  model_name: string;               // æ¨¡å‹åç§° (1-100å­—ç¬¦)
  config: Record<string, any>;      // æ¨¡å‹é…ç½®å‚æ•°
}

// æœç´¢ç»“æœ
interface SearchResult {
  file_id: number;
  file_name: string;
  file_path: string;
  file_type: FileType;
  relevance_score: number;          // ç›¸å…³æ€§åˆ†æ•° (0.0-1.0)
  preview_text: string;             // é¢„è§ˆæ–‡æœ¬ (æœ€å¤š200å­—ç¬¦)
  highlight: string;                // é«˜äº®ç‰‡æ®µ
  created_at: string;               // æ–‡ä»¶åˆ›å»ºæ—¶é—´
  modified_at: string;              // æ–‡ä»¶ä¿®æ”¹æ—¶é—´
  file_size: number;                // æ–‡ä»¶å¤§å°(å­—èŠ‚)
  match_type: string;               // åŒ¹é…ç±»å‹ semantic/fulltext/hybrid
}

// ç»Ÿä¸€å“åº”æ ¼å¼
interface SearchResponse {
  success: boolean;
  data: {
    results: SearchResult[];
    total: number;
    search_time: number;            // æœç´¢è€—æ—¶(ç§’)
    query_used: string;             // å®é™…ä½¿ç”¨çš„æŸ¥è¯¢è¯
    input_processed: boolean;       // æ˜¯å¦è¿›è¡Œäº†è¾“å…¥é¢„å¤„ç†
  };
  message?: string;
}

interface MultimodalResponse {
  success: boolean;
  data: {
    converted_text: string;         // è½¬æ¢åçš„æ–‡æœ¬
    confidence: number;             // è½¬æ¢ç½®ä¿¡åº¦
    search_results: SearchResult[];
    file_info: {
      filename: string;
      size: number;
      content_type: string;
    };
  };
  message?: string;
}

// åº”ç”¨è®¾ç½®
interface AppSettings {
  app_name: string;
  version: string;
  search: {
    default_limit: number;
    default_threshold: number;
    max_file_size: number;
  };
  indexing: {
    max_concurrent_jobs: number;
    supported_formats: string[];
    auto_rebuild: boolean;
  };
  ui: {
    theme: string;
    language: string;
  };
}

// åº”ç”¨æ—¥å¿—
interface AppLog {
  timestamp: string;
  level: 'DEBUG' | 'INFO' | 'WARNING' | 'ERROR';
  logger: string;
  message: string;
  module: string;
  details?: Record<string, any>;
}

// æ—¥å¿—æŸ¥è¯¢å“åº”
interface LogsResponse {
  success: boolean;
  data: {
    logs: AppLog[];
    total: number;
    has_more: boolean;
  };
}

// ç³»ç»Ÿå¥åº·çŠ¶æ€
interface SystemHealth {
  status: 'healthy' | 'degraded' | 'unhealthy';
  database: {
    status: string;
    response_time: number;
  };
  ai_models: Record<string, {
    status: string;
    memory_usage?: string;
    error?: string;
  }>;
  indexes: Record<string, {
    status: string;
    document_count: number;
  }>;
  timestamp: string;
}
```

## 4. æœç´¢æœåŠ¡API

### 4.1 æ–‡æœ¬æœç´¢
```http
POST /api/search
Content-Type: application/json
```

**è¯·æ±‚å‚æ•°**
```json
{
  "query": "äººå·¥æ™ºèƒ½å‘å±•è¶‹åŠ¿",
  "input_type": "text",
  "search_type": "hybrid",
  "limit": 20,
  "threshold": 0.7,
  "file_types": ["document", "pdf"]
}
```

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "data": {
    "results": [
      {
        "file_id": 1,
        "file_name": "AIå‘å±•æŠ¥å‘Š.pdf",
        "file_path": "/Users/Downloads/AIå‘å±•æŠ¥å‘Š.pdf",
        "file_type": "document",
        "relevance_score": 0.92,
        "preview_text": "äººå·¥æ™ºèƒ½æŠ€æœ¯åœ¨è¿‡å»å‡ å¹´ä¸­å–å¾—äº†çªç ´æ€§è¿›å±•...",
        "highlight": "äººå·¥æ™ºèƒ½æŠ€æœ¯åœ¨è¿‡å»å‡ å¹´ä¸­å–å¾—äº†<em>çªç ´æ€§è¿›å±•</em>",
        "created_at": "2024-01-15T10:30:00Z",
        "modified_at": "2024-01-15T10:30:00Z",
        "file_size": 2048576,
        "match_type": "hybrid"
      }
    ],
    "total": 1,
    "search_time": 0.15,
    "query_used": "äººå·¥æ™ºèƒ½å‘å±•è¶‹åŠ¿",
    "input_processed": false
  }
}
```

### 4.2 å¤šæ¨¡æ€æœç´¢
```http
POST /api/search/multimodal
Content-Type: multipart/form-data
```

**è¡¨å•å‚æ•°**
- `input_type`: è¾“å…¥ç±»å‹ (voice/image)
- `file`: ä¸Šä¼ çš„æ–‡ä»¶ (æœ€å¤§50MB)

**æ”¯æŒçš„æ–‡ä»¶æ ¼å¼**
- **è¯­éŸ³**: mp3, wav, m4a, flac (æœ€å¤§120ç§’)
- **å›¾åƒ**: jpg, jpeg, png, webp (æœ€å¤§10MB)

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "data": {
    "converted_text": "è¯·å¸®æˆ‘æ‰¾ä¸€äº›å…³äºæœºå™¨å­¦ä¹ çš„èµ„æ–™",
    "confidence": 0.95,
    "search_results": [
      {
        "file_id": 2,
        "file_name": "æœºå™¨å­¦ä¹ å…¥é—¨.docx",
        "file_path": "/Documents/æœºå™¨å­¦ä¹ å…¥é—¨.docx",
        "file_type": "document",
        "relevance_score": 0.88,
        "preview_text": "æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªé‡è¦åˆ†æ”¯...",
        "highlight": "æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªé‡è¦åˆ†æ”¯",
        "created_at": "2024-01-10T09:20:00Z",
        "modified_at": "2024-01-10T09:20:00Z",
        "file_size": 1024576,
        "match_type": "semantic"
      }
    ],
    "file_info": {
      "filename": "recording.wav",
      "size": 1024000,
      "content_type": "audio/wav"
    }
  }
}
```

### 4.3 æœç´¢å†å²
```http
GET /api/search/history?limit=20&offset=0
```

**æŸ¥è¯¢å‚æ•°**
- `limit`: è¿”å›æ•°é‡ (1-100)
- `offset`: åç§»é‡

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "data": {
    "history": [
      {
        "id": 1,
        "search_query": "äººå·¥æ™ºèƒ½å‘å±•è¶‹åŠ¿",
        "input_type": "text",
        "search_type": "hybrid",
        "ai_model_used": "bge-m3",
        "result_count": 5,
        "response_time": 0.15,
        "created_at": "2024-01-20T14:30:00Z"
      }
    ],
    "total": 1
  }
}
```

### 4.4 åˆ é™¤æœç´¢å†å²
```http
DELETE /api/search/history/{id}
```

**è·¯å¾„å‚æ•°**
- `id`: æœç´¢å†å²è®°å½•ID

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "message": "æœç´¢å†å²åˆ é™¤æˆåŠŸ"
}
```

### 4.5 æ¸…ç©ºæœç´¢å†å²
```http
DELETE /api/search/history
```

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "message": "æœç´¢å†å²å·²æ¸…ç©º"
}
```

### 4.6 æœç´¢å»ºè®®
```http
GET /api/search/suggestions?query=äººå·¥æ™º&limit=5
```

**æŸ¥è¯¢å‚æ•°**
- `query`: æœç´¢æŸ¥è¯¢å‰ç¼€
- `limit`: è¿”å›å»ºè®®æ•°é‡ (1-20)ï¼Œé»˜è®¤5

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "data": {
    "suggestions": [
      "äººå·¥æ™ºèƒ½",
      "äººå·¥æ™ºèƒ½æŠ€æœ¯",
      "äººå·¥æ™ºèƒ½å‘å±•è¶‹åŠ¿",
      "äººå·¥æ™ºèƒ½åº”ç”¨",
      "äººå·¥æ™ºèƒ½ç®—æ³•"
    ],
    "query": "äººå·¥æ™º",
    "total": 5
  }
}
```

## 5. ç´¢å¼•ç®¡ç†API

### 5.1 åˆ›å»ºç´¢å¼•
```http
POST /api/index/create
Content-Type: application/json
```

**è¯·æ±‚å‚æ•°**
```json
{
  "folder_path": "/Users/Documents",
  "file_types": ["pdf", "txt", "md", "docx", "xlsx", "mp3", "mp4", "wav"],
  "recursive": true
}
```

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "data": {
    "index_id": 1,
    "status": "processing",
    "message": "ç´¢å¼•ä»»åŠ¡å·²åˆ›å»ºå¹¶å¼€å§‹æ‰§è¡Œ"
  }
}
```

### 5.2 æŸ¥è¯¢ç´¢å¼•çŠ¶æ€
```http
GET /api/index/status/{index_id}
```

**è·¯å¾„å‚æ•°**
- `index_id`: ç´¢å¼•ä»»åŠ¡ID

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "data": {
    "index_id": 1,
    "folder_path": "/Users/Documents",
    "status": "processing",
    "progress": 45,
    "total_files": 100,
    "processed_files": 45,
    "error_count": 2,
    "started_at": "2024-01-20T10:00:00Z",
    "completed_at": null,
    "error_message": null
  }
}
```

### 5.3 åˆ é™¤ç´¢å¼•
```http
DELETE /api/index/{index_id}
```

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "message": "ç´¢å¼•åˆ é™¤æˆåŠŸ"
}
```

### 5.4 ç´¢å¼•åˆ—è¡¨
```http
GET /api/index/list?status=completed&limit=10
```

**æŸ¥è¯¢å‚æ•°**
- `status`: ä»»åŠ¡çŠ¶æ€è¿‡æ»¤ (pending/processing/completed/failed)
- `limit`: è¿”å›æ•°é‡

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "data": {
    "indexes": [
      {
        "id": 1,
        "folder_path": "/Users/Documents",
        "status": "completed",
        "total_files": 100,
        "processed_files": 98,
        "error_count": 2,
        "created_at": "2024-01-20T10:00:00Z",
        "completed_at": "2024-01-20T10:15:00Z"
      }
    ],
    "total": 1
  }
}
```

## 6. AIæ¨¡å‹é…ç½®API

### 6.1 æ›´æ–°AIæ¨¡å‹é…ç½®
```http
POST /api/config/ai-model
Content-Type: application/json
```

**è¯·æ±‚å‚æ•°**
```json
{
  "model_type": "embedding",
  "provider": "local",
  "model_name": "bge-m3",
  "config": {
    "model_path": "/data/models/bge-m3",
    "device": "cpu",
    "embedding_dim": 1024,
    "max_length": 8192
  }
}
```

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "message": "AIæ¨¡å‹é…ç½®æ›´æ–°æˆåŠŸ"
}
```

### 6.2 è·å–æ‰€æœ‰AIæ¨¡å‹é…ç½®
```http
GET /api/config/ai-models
```

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "model_type": "embedding",
      "provider": "local",
      "model_name": "bge-m3",
      "config_json": "{\"model_path\": \"/models/bge-m3\", \"device\": \"cpu\"}",
      "is_active": true,
      "created_at": "2024-01-15T08:00:00Z",
      "updated_at": "2024-01-15T08:00:00Z"
    },
    {
      "id": 2,
      "model_type": "speech",
      "provider": "cloud",
      "model_name": "aliyun-asr",
      "config_json": "{\"api_key\": \"***\", \"endpoint\": \"https://nls-gateway.cn-shanghai.aliyuncs.com\"}",
      "is_active": false,
      "created_at": "2024-01-15T08:30:00Z",
      "updated_at": "2024-01-15T08:30:00Z"
    }
  ]
}
```

### 6.3 æµ‹è¯•AIæ¨¡å‹
```http
POST /api/config/ai-model/{model_id}/test
```

**è·¯å¾„å‚æ•°**
- `model_id`: æ¨¡å‹é…ç½®ID

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "data": {
    "model_id": 1,
    "test_passed": true,
    "response_time": 0.12,
    "test_message": "BGE-M3æ¨¡å‹æµ‹è¯•æˆåŠŸï¼Œå“åº”æ—¶é—´ï¼š120ms"
  }
}
```

### 6.4 å¯ç”¨/ç¦ç”¨AIæ¨¡å‹
```http
PUT /api/config/ai-model/{model_id}/toggle
```

**è·¯å¾„å‚æ•°**
- `model_id`: æ¨¡å‹é…ç½®ID

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "message": "AIæ¨¡å‹çŠ¶æ€åˆ‡æ¢æˆåŠŸ",
  "data": {
    "model_id": 1,
    "is_active": false,
    "previous_status": true
  }
}
```

### 6.5 åˆ é™¤AIæ¨¡å‹é…ç½®
```http
DELETE /api/config/ai-model/{model_id}
```

**è·¯å¾„å‚æ•°**
- `model_id`: æ¨¡å‹é…ç½®ID

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "message": "AIæ¨¡å‹é…ç½®åˆ é™¤æˆåŠŸ"
}
```

### 6.6 è·å–é»˜è®¤AIæ¨¡å‹é…ç½®
```http
GET /api/config/ai-models/default
```

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "model_type": "embedding",
      "provider": "local",
      "model_name": "bge-m3",
      "is_default": true,
      "config_json": "{\"model_path\": \"/models/bge-m3\"}"
    },
    {
      "id": 4,
      "model_type": "speech",
      "provider": "local",
      "model_name": "faster-whisper",
      "is_default": true,
      "config_json": "{\"model_size\": \"base\"}"
    }
  ]
}
```

## 7. ç³»ç»Ÿç®¡ç†API

### 7.1 ç³»ç»Ÿå¥åº·æ£€æŸ¥
```http
GET /api/system/health
```

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "data": {
    "status": "healthy",
    "database": {
      "status": "connected",
      "response_time": 0.002
    },
    "ai_models": {
      "bge_m3": {
        "status": "loaded",
        "memory_usage": "2.1GB"
      },
      "faster_whisper": {
        "status": "not_loaded",
        "error": null
      }
    },
    "indexes": {
      "faiss_index": {
        "status": "ready",
        "document_count": 15420
      },
      "whoosh_index": {
        "status": "ready",
        "document_count": 15420
      }
    },
    "timestamp": "2024-01-20T15:30:00Z"
  }
}
```

## 8. åº”ç”¨æ—¥å¿—API

### 8.1 è·å–åº”ç”¨æ—¥å¿—
```http
GET /api/system/logs?level=info&limit=100&offset=0
```

**æŸ¥è¯¢å‚æ•°**
- `level`: æ—¥å¿—çº§åˆ«è¿‡æ»¤ (debug/info/warning/error)ï¼Œé»˜è®¤info
- `limit`: è¿”å›æ•°é‡ (1-1000)ï¼Œé»˜è®¤100
- `offset`: åç§»é‡ï¼Œé»˜è®¤0

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "data": {
    "logs": [
      {
        "timestamp": "2024-01-20T16:30:00Z",
        "level": "INFO",
        "logger": "app.search",
        "message": "æœç´¢è¯·æ±‚å¤„ç†å®Œæˆ",
        "module": "search",
        "details": {
          "query": "äººå·¥æ™ºèƒ½",
          "results_count": 15,
          "processing_time": 0.23
        }
      },
      {
        "timestamp": "2024-01-20T16:29:45Z",
        "level": "WARNING",
        "logger": "app.index",
        "message": "æ–‡ä»¶è§£æå¤±è´¥",
        "module": "index",
        "details": {
          "file_path": "/docs/corrupted.pdf",
          "error": "PDFæ–‡ä»¶æŸå"
        }
      }
    ],
    "total": 1247,
    "has_more": true
  }
}
```

### 8.2 ä¸‹è½½æ—¥å¿—æ–‡ä»¶
```http
GET /api/system/logs/download?date=2024-01-20
```

**æŸ¥è¯¢å‚æ•°**
- `date`: æ—¥æœŸ (YYYY-MM-DDæ ¼å¼)ï¼Œå¯é€‰ï¼Œä¸æä¾›åˆ™ä¸‹è½½ä»Šæ—¥æ—¥å¿—

**å“åº”**
- Content-Type: `application/octet-stream`
- Content-Disposition: `attachment; filename="xiaoyao-search-2024-01-20.log"`

## 9. WebSocketæ¥å£

### 9.1 ç´¢å¼•è¿›åº¦å®æ—¶æ¨é€
```javascript
// è¿æ¥WebSocket
const ws = new WebSocket('ws://127.0.0.1:8000/ws/index/{index_id}');

// æ¥æ”¶æ¶ˆæ¯æ ¼å¼
{
  "type": "progress_update",
  "data": {
    "index_id": 1,
    "status": "processing",
    "progress": 75,
    "processed_files": 75,
    "total_files": 100,
    "current_file": "/Users/Documents/report.pdf"
  }
}

{
  "type": "completed",
  "data": {
    "index_id": 1,
    "status": "completed",
    "progress": 100,
    "processed_files": 98,
    "total_files": 100,
    "error_count": 2,
    "completed_at": "2024-01-20T10:15:00Z"
  }
}
```

### 9.2 æœç´¢å»ºè®®æ¨é€
```javascript
// è¿æ¥æœç´¢å»ºè®®WebSocket
const ws = new WebSocket('ws://127.0.0.1:8000/ws/search-suggest');

// å‘é€æŸ¥è¯¢
ws.send(JSON.stringify({
  "query": "äººå·¥æ™º",
  "limit": 5
}));

// æ¥æ”¶å»ºè®®
{
  "type": "suggestions",
  "data": {
    "suggestions": [
      "äººå·¥æ™ºèƒ½",
      "äººå·¥æ™ºèƒ½æŠ€æœ¯",
      "äººå·¥æ™ºèƒ½å‘å±•è¶‹åŠ¿",
      "äººå·¥æ™ºèƒ½åº”ç”¨",
      "äººå·¥æ™ºèƒ½ç®—æ³•"
    ]
  }
}
```

## 10. å‰ç«¯é›†æˆç¤ºä¾‹

### 10.1 Axiosé…ç½®
```typescript
// api/config.ts
import axios from 'axios';

const api = axios.create({
  baseURL: 'http://127.0.0.1:8000',
  timeout: 30000,
  headers: {
    'Content-Type': 'application/json'
  }
});

// å“åº”æ‹¦æˆªå™¨
api.interceptors.response.use(
  response => response.data,
  error => {
    console.error('API Error:', error.response?.data || error.message);
    return Promise.reject(error);
  }
);

export default api;
```

### 10.2 æœç´¢æœåŠ¡å°è£…
```typescript
// api/search.ts
import api from './config';

export interface SearchParams {
  query: string;
  input_type?: 'text' | 'voice' | 'image';
  search_type?: 'semantic' | 'fulltext' | 'hybrid';
  limit?: number;
  threshold?: number;
  file_types?: string[];
}

export class SearchService {
  // æ–‡æœ¬æœç´¢
  static async search(params: SearchParams) {
    return await api.post('/api/search', params);
  }

  // å¤šæ¨¡æ€æœç´¢
  static async multimodalSearch(inputType: 'voice' | 'image', file: File) {
    const formData = new FormData();
    formData.append('input_type', inputType);
    formData.append('file', file);

    return await api.post('/api/search/multimodal', formData, {
      headers: {
        'Content-Type': 'multipart/form-data'
      }
    });
  }

  // æœç´¢å†å²
  static async getHistory(limit = 20, offset = 0) {
    return await api.get(`/api/search/history?limit=${limit}&offset=${offset}`);
  }
}
```

### 10.3 ç´¢å¼•ç®¡ç†å°è£…
```typescript
// api/index.ts
import api from './config';

export class IndexService {
  // åˆ›å»ºç´¢å¼•
  static async createIndex(params: {
    folder_path: string;
    file_types?: string[];
    recursive?: boolean;
  }) {
    return await api.post('/api/index/create', params);
  }

  // è·å–ç´¢å¼•çŠ¶æ€
  static async getIndexStatus(indexId: number) {
    return await api.get(`/api/index/status/${indexId}`);
  }

  // åˆ é™¤ç´¢å¼•
  static async deleteIndex(indexId: number) {
    return await api.delete(`/api/index/${indexId}`);
  }

  // ç´¢å¼•åˆ—è¡¨
  static async getIndexList(status?: string, limit = 10) {
    const params = new URLSearchParams();
    if (status) params.append('status', status);
    params.append('limit', limit.toString());

    return await api.get(`/api/index/list?${params.toString()}`);
  }
}
```

### 10.4 Vueç»„ä»¶ç¤ºä¾‹
```vue
<!-- components/SearchInterface.vue -->
<template>
  <div class="search-interface">
    <!-- æœç´¢è¾“å…¥ -->
    <a-input-search
      v-model:value="searchQuery"
      placeholder="è¾“å…¥æœç´¢å†…å®¹..."
      size="large"
      @search="handleSearch"
      :loading="searching"
    />

    <!-- å¤šæ¨¡æ€è¾“å…¥ -->
    <div class="multimodal-input">
      <a-upload
        :before-upload="handleMultimodalUpload"
        :show-upload-list="false"
        accept=".mp3,.wav,.jpg,.jpeg,.png"
      >
        <a-button type="primary" ghost>
          <CameraOutlined v-if="inputType === 'image'" />
          <AudioOutlined v-else />
          {{ inputType === 'image' ? 'å›¾ç‰‡æœç´¢' : 'è¯­éŸ³æœç´¢' }}
        </a-button>
      </a-upload>
    </div>

    <!-- æœç´¢ç»“æœ -->
    <div class="search-results" v-if="results.length > 0">
      <a-list
        :data-source="results"
        item-layout="vertical"
        size="large"
      >
        <template #renderItem="{ item }">
          <a-list-item>
            <a-list-item-meta>
              <template #title>
                <a @click="openFile(item.file_path)">{{ item.file_name }}</a>
              </template>
              <template #description>
                <a-tag :color="getFileTypeColor(item.file_type)">
                  {{ item.file_type }}
                </a-tag>
                <span class="relevance-score">
                  ç›¸å…³æ€§: {{ (item.relevance_score * 100).toFixed(1) }}%
                </span>
              </template>
            </a-list-item-meta>
            <div class="preview-text" v-html="item.highlight"></div>
          </a-list-item>
        </template>
      </a-list>
    </div>
  </div>
</template>

<script lang="ts" setup>
import { ref, reactive } from 'vue';
import { message } from 'ant-design-vue';
import { SearchService } from '@/api/search';
import type { SearchResult } from '@/types/api';

const searchQuery = ref('');
const searching = ref(false);
const inputType = ref<'voice' | 'image'>('image');
const results = ref<SearchResult[]>([]);

const handleSearch = async () => {
  if (!searchQuery.value.trim()) {
    message.warning('è¯·è¾“å…¥æœç´¢å†…å®¹');
    return;
  }

  searching.value = true;
  try {
    const response = await SearchService.search({
      query: searchQuery.value,
      search_type: 'hybrid',
      limit: 20
    });

    if (response.success) {
      results.value = response.data.results;
      message.success(`æ‰¾åˆ° ${response.data.total} ä¸ªç›¸å…³æ–‡ä»¶`);
    }
  } catch (error) {
    message.error('æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•');
    console.error('Search error:', error);
  } finally {
    searching.value = false;
  }
};

const handleMultimodalUpload = async (file: File) => {
  const isImage = file.type.startsWith('image/');
  inputType.value = isImage ? 'image' : 'voice';

  try {
    const response = await SearchService.multimodalSearch(inputType.value, file);

    if (response.success) {
      results.value = response.data.search_results;
      message.success(`è¯­éŸ³è¯†åˆ«: "${response.data.converted_text}"`);
    }
  } catch (error) {
    message.error('å¤šæ¨¡æ€æœç´¢å¤±è´¥');
    console.error('Multimodal search error:', error);
  }

  return false; // é˜»æ­¢é»˜è®¤ä¸Šä¼ è¡Œä¸º
};

const openFile = (filePath: string) => {
  // æ‰“å¼€æ–‡ä»¶çš„é€»è¾‘
  window.api.openFile(filePath);
};

const getFileTypeColor = (type: string) => {
  const colors = {
    document: 'blue',
    image: 'green',
    audio: 'orange',
    video: 'red'
  };
  return colors[type] || 'default';
};
</script>
```

## 11. é”™è¯¯ç å‚è€ƒ

### 11.1 é€šç”¨é”™è¯¯ç 
| é”™è¯¯ç  | HTTPçŠ¶æ€ç  | è¯´æ˜ |
|--------|------------|------|
| SUCCESS | 200 | æ“ä½œæˆåŠŸ |
| VALIDATION_ERROR | 400 | è¯·æ±‚å‚æ•°éªŒè¯å¤±è´¥ |
| UNAUTHORIZED | 401 | æœªæˆæƒè®¿é—® |
| FORBIDDEN | 403 | ç¦æ­¢è®¿é—® |
| NOT_FOUND | 404 | èµ„æºä¸å­˜åœ¨ |
| METHOD_NOT_ALLOWED | 405 | è¯·æ±‚æ–¹æ³•ä¸å…è®¸ |
| PAYLOAD_TOO_LARGE | 413 | è¯·æ±‚ä½“è¿‡å¤§ |
| UNSUPPORTED_MEDIA_TYPE | 415 | ä¸æ”¯æŒçš„åª’ä½“ç±»å‹ |
| RATE_LIMIT_EXCEEDED | 429 | è¯·æ±‚é¢‘ç‡è¶…é™ |
| INTERNAL_ERROR | 500 | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ |
| SERVICE_UNAVAILABLE | 503 | æœåŠ¡ä¸å¯ç”¨ |

### 11.2 ä¸šåŠ¡é”™è¯¯ç 
| é”™è¯¯ç  | è¯´æ˜ | è§£å†³æ–¹æ¡ˆ |
|--------|------|----------|
| SEARCH_QUERY_EMPTY | æœç´¢æŸ¥è¯¢ä¸èƒ½ä¸ºç©º | æ£€æŸ¥queryå‚æ•° |
| SEARCH_THRESHOLD_INVALID | ç›¸ä¼¼åº¦é˜ˆå€¼è¶…å‡ºèŒƒå›´ | ä½¿ç”¨0.0-1.0ä¹‹é—´çš„å€¼ |
| FILE_TOO_LARGE | æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶ | å‹ç¼©æ–‡ä»¶æˆ–åˆ†å‰²ä¸Šä¼  |
| UNSUPPORTED_FILE_TYPE | ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹ | ä½¿ç”¨æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ |
| FOLDER_NOT_FOUND | æ–‡ä»¶å¤¹ä¸å­˜åœ¨ | æ£€æŸ¥folder_pathå‚æ•° |
| INDEX_JOB_RUNNING | ç´¢å¼•ä»»åŠ¡æ­£åœ¨è¿è¡Œ | ç­‰å¾…å½“å‰ä»»åŠ¡å®Œæˆæˆ–å–æ¶ˆ |
| MODEL_NOT_FOUND | AIæ¨¡å‹é…ç½®ä¸å­˜åœ¨ | æ£€æŸ¥model_idæˆ–åˆ›å»ºæ–°é…ç½® |
| MODEL_LOAD_FAILED | AIæ¨¡å‹åŠ è½½å¤±è´¥ | æ£€æŸ¥æ¨¡å‹è·¯å¾„å’Œä¾èµ–ç¯å¢ƒ |
| DATABASE_CONNECTION_FAILED | æ•°æ®åº“è¿æ¥å¤±è´¥ | æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶æƒé™ |
| INSUFFICIENT_MEMORY | å†…å­˜ä¸è¶³ | é‡Šæ”¾å†…å­˜æˆ–å¢åŠ ç³»ç»Ÿå†…å­˜ |

### 11.3 é”™è¯¯å¤„ç†æœ€ä½³å®è·µ
```typescript
// ç»Ÿä¸€é”™è¯¯å¤„ç†å‡½æ•°
const handleApiError = (error: any) => {
  if (error.response) {
    const { status, data } = error.response;

    switch (status) {
      case 400:
        message.error(data.error?.details || 'è¯·æ±‚å‚æ•°é”™è¯¯');
        break;
      case 404:
        message.error('è¯·æ±‚çš„èµ„æºä¸å­˜åœ¨');
        break;
      case 413:
        message.error('æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶ï¼ˆ50MBï¼‰');
        break;
      case 500:
        message.error('æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
        break;
      default:
        message.error(`è¯·æ±‚å¤±è´¥ (${status})`);
    }
  } else if (error.request) {
    message.error('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡');
  } else {
    message.error('è¯·æ±‚é…ç½®é”™è¯¯');
  }
};

// ä½¿ç”¨ç¤ºä¾‹
try {
  const response = await SearchService.search(params);
  // å¤„ç†æˆåŠŸå“åº”
} catch (error) {
  handleApiError(error);
}
```

---

## æ›´æ–°æ—¥å¿—

### v1.1.0 (2025-11-25)
- åˆå§‹ç‰ˆæœ¬å‘å¸ƒ
- å®Œæ•´çš„æœç´¢ã€ç´¢å¼•ã€é…ç½®ç®¡ç†API
- å¤šæ¨¡æ€æœç´¢æ”¯æŒ
- WebSocketå®æ—¶é€šä¿¡
- å‰ç«¯é›†æˆç¤ºä¾‹
- **æ–°å¢**: æœç´¢å†å²åˆ é™¤API (DELETE /api/search/history) âœ… å·²å®ç°
- **æ–°å¢**: åº”ç”¨æ—¥å¿—æŸ¥è¯¢API (GET /api/system/logs) âœ… å·²å®ç°
- **æ–°å¢**: æ—¥å¿—æ–‡ä»¶ä¸‹è½½API (GET /api/system/logs/download) âœ… å·²å®ç°
- **å®Œå–„**: è¡¥å……AppSettingså’ŒAppLogæ•°æ®æ¨¡å‹å®šä¹‰

---

## ğŸ“‹ APIå®ç°çŠ¶æ€æ€»è§ˆ

### âœ… å®Œå…¨å®ç°çš„APIæ¨¡å—
- **æœç´¢API** (6/6): 100% å®Œæˆ
  - âœ… POST /api/search - æ–‡æœ¬æœç´¢
  - âœ… POST /api/search/multimodal - å¤šæ¨¡æ€æœç´¢
  - âœ… GET /api/search/history - è·å–æœç´¢å†å²
  - âœ… DELETE /api/search/history/{id} - åˆ é™¤å•æ¡æœç´¢å†å² *(2025-11-25å®ç°)*
  - âœ… DELETE /api/search/history - æ¸…ç©ºæœç´¢å†å²
  - âœ… GET /api/search/suggestions - æœç´¢å»ºè®®

- **ç´¢å¼•API** (10/10): 100% å®Œæˆ
- **ç³»ç»ŸAPI** (1/1): 100% å®Œæˆ
  - âœ… GET /api/system/health - ç³»ç»Ÿå¥åº·æ£€æŸ¥ *(2025-11-28ç®€åŒ–)*
- **é…ç½®API** (6/6): 100% å®Œæˆ

### ğŸ“Š æ€»ä½“ç»Ÿè®¡
- **æ€»æ¥å£æ•°**: 23ä¸ª *(ç§»é™¤äº†å†—ä½™çš„AIæ¨¡å‹ç®¡ç†API 9ä¸ªæ¥å£)*
- **å·²å®ç°**: 23ä¸ª (100%)
- **å®ç°å®Œæˆåº¦**: 100%

### ğŸ—‘ï¸ å·²ç§»é™¤çš„å†—ä½™æ¨¡å—
- **AIæ¨¡å‹ç®¡ç†API** (9/9): å·²åˆ é™¤ *(åŠŸèƒ½åˆå¹¶åˆ°é…ç½®APIä¸­)*
  - âŒ GET /api/ai/status - è·å–AIæ¨¡å‹çŠ¶æ€ *(åŠŸèƒ½é‡å¤)*
  - âŒ GET /api/ai/models - è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨ *(åŠŸèƒ½é‡å¤)*
  - âŒ POST /api/ai/load/{model_id} - åŠ è½½æŒ‡å®šæ¨¡å‹ *(åŠŸèƒ½é‡å¤)*
  - âŒ POST /api/ai/unload/{model_id} - å¸è½½æŒ‡å®šæ¨¡å‹ *(åŠŸèƒ½é‡å¤)*
  - âŒ POST /api/ai/load-all - åŠ è½½æ‰€æœ‰æ¨¡å‹ *(åŠŸèƒ½é‡å¤)*
  - âŒ POST /api/ai/unload-all - å¸è½½æ‰€æœ‰æ¨¡å‹ *(åŠŸèƒ½é‡å¤)*
  - âŒ GET /api/ai/health - AIæ¨¡å‹å¥åº·æ£€æŸ¥ *(åŠŸèƒ½é‡å¤)*
  - âŒ POST /api/ai/benchmark - AIæ¨¡å‹æ€§èƒ½åŸºå‡†æµ‹è¯• *(åŠŸèƒ½é‡å¤)*
  - âŒ GET /api/ai/text-embedding - æ–‡æœ¬åµŒå…¥æµ‹è¯• *(åŠŸèƒ½é‡å¤)*

**æœ€åæ›´æ–°æ—¶é—´**: 2025å¹´11æœˆ28æ—¥
**æ›´æ–°å†…å®¹**: ç§»é™¤å†—ä½™çš„AIæ¨¡å‹ç®¡ç†APIæ¨¡å—ï¼Œç²¾ç®€æ¶æ„ï¼Œæ¥å£æ€»æ•°ä»32ä¸ªä¼˜åŒ–ä¸º23ä¸ª

---

**ç»´æŠ¤å›¢é˜Ÿ**: å°é¥æœç´¢å¼€å‘ç»„
**æŠ€æœ¯æ”¯æŒ**: [GitHub Issues](https://github.com/your-repo/issues)
**æ–‡æ¡£æ›´æ–°**: 2025-11-25