<template>
  <a-config-provider :theme="{ token: { colorPrimary: '#6366F1' } }">
    <div class="index-app">
      <a-layout class="layout">
        <!-- å¤´éƒ¨å¯¼èˆª -->
        <a-layout-header class="header">
          <div class="header-content">
            <div class="logo">
              <span class="logo-icon">ğŸ“</span>
              <span class="logo-text">ç´¢å¼•ç®¡ç†</span>
            </div>
            <div class="header-actions">
              <a-button @click="goBack">
                <template #icon><ArrowLeftOutlined /></template>
                è¿”å›
              </a-button>
            </div>
          </div>
        </a-layout-header>

        <!-- ä¸»è¦å†…å®¹åŒº -->
        <a-layout-content class="content">
          <div class="index-container">
            <div class="index-layout">
              <!-- å·²ç´¢å¼•æ–‡ä»¶å¤¹åŒºåŸŸ -->
              <div class="section">
                <div class="section-header">
                  <h2>
                    <template #icon><FolderOpenOutlined /></template>
                    å·²ç´¢å¼•æ–‡ä»¶å¤¹
                  </h2>
                  <div class="section-actions">
                    <a-button @click="showAddFolderModal" type="primary">
                      <template #icon><PlusOutlined /></template>
                      æ·»åŠ æ–‡ä»¶å¤¹
                    </a-button>
                    <a-button @click="rebuildAllIndexes" :loading="isRebuildingAll">
                      <template #icon><ReloadOutlined /></template>
                      å…¨éƒ¨é‡å»º
                    </a-button>
                    <a-button @click="clearAllIndexes" danger>
                      <template #icon><DeleteOutlined /></template>
                      æ¸…ç©ºæ‰€æœ‰
                    </a-button>
                  </div>
                </div>

                <div class="folder-list">
                  <div
                    v-for="(folder, index) in indexedFolders"
                    :key="index"
                    class="folder-card"
                  >
                    <a-card>
                      <template #title>
                        <div class="folder-title">
                          <span class="folder-icon">ğŸ“</span>
                          <span class="folder-path">{{ folder.path }}</span>
                          <a-tag
                            :color="folder.status === 'completed' ? 'green' : 'orange'"
                            class="status-tag"
                          >
                            {{ getStatusText(folder.status) }}
                          </a-tag>
                        </div>
                      </template>

                      <div class="folder-stats">
                        <div class="stat-item">
                          <span class="stat-label">æ–‡ä»¶æ•°:</span>
                          <span class="stat-value">{{ folder.fileCount.toLocaleString() }}</span>
                        </div>
                        <div class="stat-item">
                          <span class="stat-label">å¤§å°:</span>
                          <span class="stat-value">{{ formatSize(folder.size) }}</span>
                        </div>
                        <div class="stat-item">
                          <span class="stat-label">æœ€åæ›´æ–°:</span>
                          <span class="stat-value">{{ folder.lastUpdate }}</span>
                        </div>
                      </div>

                      <template #actions>
                        <a-button
                          size="small"
                          @click="rebuildIndex(folder)"
                          :loading="folder.isRebuilding"
                        >
                          <template #icon><ReloadOutlined /></template>
                          é‡å»º
                        </a-button>
                        <a-button
                          size="small"
                          @click="deleteIndex(folder)"
                          :loading="folder.isDeleting"
                        >
                          <template #icon><DeleteOutlined /></template>
                          åˆ é™¤
                        </a-button>
                        <a-button size="small" @click="openFolder(folder)">
                          <template #icon><FolderOutlined /></template>
                          æ‰“å¼€
                        </a-button>
                      </template>
                    </a-card>
                  </div>

                  <!-- ç©ºçŠ¶æ€ -->
                  <a-empty
                    v-if="indexedFolders.length === 0"
                    description="æš‚æ— ç´¢å¼•æ–‡ä»¶å¤¹"
                    class="empty-state"
                  >
                    <template #image>
                      <FolderOutlined style="font-size: 64px; color: #d9d9d9;" />
                    </template>
                    <a-button type="primary" @click="showAddFolderModal">
                      æ·»åŠ ç¬¬ä¸€ä¸ªæ–‡ä»¶å¤¹
                    </a-button>
                  </a-empty>
                </div>
              </div>

              <!-- ç´¢å¼•ç»Ÿè®¡åŒºåŸŸ -->
              <div class="section">
                <div class="section-header">
                  <h2>
                    <template #icon><BarChartOutlined /></template>
                    ç´¢å¼•ç»Ÿè®¡
                  </h2>
                  <div class="section-actions">
                    <a-button @click="exportStats">
                      <template #icon><ExportOutlined /></template>
                      å¯¼å‡ºç»Ÿè®¡
                    </a-button>
                    <a-button @click="cleanCache">
                      <template #icon><ClearOutlined /></template>
                      æ¸…ç†ç¼“å­˜
                    </a-button>
                  </div>
                </div>

                <div class="stats-grid">
                  <div class="stat-card">
                    <div class="stat-icon">
                      <FileTextOutlined />
                    </div>
                    <div class="stat-content">
                      <div class="stat-number">{{ totalFiles.toLocaleString() }}</div>
                      <div class="stat-label">æ€»æ–‡ä»¶æ•°</div>
                    </div>
                  </div>

                  <div class="stat-card">
                    <div class="stat-icon">
                      <DatabaseOutlined />
                    </div>
                    <div class="stat-content">
                      <div class="stat-number">{{ formatSize(totalSize) }}</div>
                      <div class="stat-label">æ€»å¤§å°</div>
                    </div>
                  </div>

                  <div class="stat-card">
                    <div class="stat-icon">
                      <FileOutlined />
                    </div>
                    <div class="stat-content">
                      <div class="stat-number">{{ supportedFormats }}</div>
                      <div class="stat-label">æ”¯æŒæ ¼å¼</div>
                    </div>
                  </div>

                  <div class="stat-card">
                    <div class="stat-icon">
                      <HardDriveOutlined />
                    </div>
                    <div class="stat-content">
                      <div class="stat-number">{{ formatSize(indexSize) }}</div>
                      <div class="stat-label">ç´¢å¼•å¤§å°</div>
                    </div>
                  </div>
                </div>

                <div class="progress-section">
                  <h3>ç´¢å¼•è¿›åº¦</h3>
                  <a-progress
                    :percent="indexProgress"
                    :status="indexProgress === 100 ? 'success' : 'active'"
                  />
                  <div class="progress-info">
                    <span>æœ€åæ›´æ–°: {{ lastUpdateTime }}</span>
                    <span v-if="indexProgress < 100" class="progress-text">
                      æ­£åœ¨ç´¢å¼•ä¸­...
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </a-layout-content>
      </a-layout>

      <!-- æ·»åŠ æ–‡ä»¶å¤¹å¼¹çª— -->
      <a-modal
        v-model:open="showAddModal"
        title="æ·»åŠ ç´¢å¼•æ–‡ä»¶å¤¹"
        @ok="confirmAddFolder"
        @cancel="cancelAddFolder"
        width="600px"
        :confirm-loading="isAddingFolder"
      >
        <a-form layout="vertical">
          <a-form-item label="é€‰æ‹©æ–‡ä»¶å¤¹" required>
            <div class="folder-selector">
              <a-input
                v-model:value="newFolderPath"
                placeholder="é€‰æ‹©è¦ç´¢å¼•çš„æ–‡ä»¶å¤¹è·¯å¾„"
                readonly
                @click="selectFolder"
              >
                <template #suffix>
                  <a-button size="small" @click="selectFolder">
                    æµè§ˆ...
                  </a-button>
                </template>
              </a-input>
            </div>
          </a-form-item>

          <a-form-item label="ç´¢å¼•é€‰é¡¹">
            <div class="index-options">
              <a-checkbox v-model:checked="indexOptions.includeSubfolders">
                åŒ…å«å­æ–‡ä»¶å¤¹
              </a-checkbox>
              <a-checkbox v-model:checked="indexOptions.indexContent">
                ç´¢å¼•æ–‡ä»¶å†…å®¹
              </a-checkbox>
              <a-checkbox v-model:checked="indexOptions.monitorChanges">
                ç›‘è§†æ–‡ä»¶å˜åŒ–
              </a-checkbox>
            </div>
          </a-form-item>

          <a-form-item label="æ–‡ä»¶ç±»å‹è¿‡æ»¤">
            <div class="file-type-filters">
              <div class="filter-group">
                <a-checkbox v-model:checked="fileFilters.documents">
                  ğŸ“„ æ–‡æ¡£ (txt, md, pdf, docx...)
                </a-checkbox>
              </div>
              <div class="filter-group">
                <a-checkbox v-model:checked="fileFilters.audio">
                  ğŸµ éŸ³é¢‘ (mp3, wav, m4a...)
                </a-checkbox>
              </div>
              <div class="filter-group">
                <a-checkbox v-model:checked="fileFilters.video">
                  ğŸ¬ è§†é¢‘ (mp4, avi, mov...)
                </a-checkbox>
              </div>
              <div class="filter-group">
                <a-checkbox v-model:checked="fileFilters.images">
                  ğŸ–¼ï¸ å›¾ç‰‡ (jpg, png, gif...)
                </a-checkbox>
              </div>
              <div class="filter-group">
                <a-checkbox v-model:checked="fileFilters.code">
                  ğŸ’» ä»£ç  (js, py, java...)
                </a-checkbox>
              </div>
            </div>
          </a-form-item>
        </a-form>
      </a-modal>

      <!-- é‡å»ºç´¢å¼•ç¡®è®¤å¼¹çª— -->
      <a-modal
        v-model:open="showRebuildModal"
        title="é‡å»ºç´¢å¼•"
        @ok="confirmRebuild"
        @cancel="cancelRebuild"
        :confirm-loading="isRebuilding"
      >
        <p>ç¡®å®šè¦é‡å»ºæ–‡ä»¶å¤¹ "{{ rebuildTarget?.path }}" çš„ç´¢å¼•å—ï¼Ÿ</p>
        <p>è¿™ä¸ªè¿‡ç¨‹å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ï¼ŒæœŸé—´å°†æš‚åœå¯¹è¯¥æ–‡ä»¶å¤¹çš„æœç´¢ã€‚</p>
      </a-modal>

      <!-- åˆ é™¤ç´¢å¼•ç¡®è®¤å¼¹çª— -->
      <a-modal
        v-model:open="showDeleteModal"
        title="åˆ é™¤ç´¢å¼•"
        @ok="confirmDelete"
        @cancel="cancelDelete"
        :confirm-loading="isDeleting"
        ok-text="åˆ é™¤"
        cancel-text="å–æ¶ˆ"
        ok-type="danger"
      >
        <p>ç¡®å®šè¦åˆ é™¤æ–‡ä»¶å¤¹ "{{ deleteTarget?.path }}" çš„ç´¢å¼•å—ï¼Ÿ</p>
        <p style="color: #ff4d4f;">åˆ é™¤åå°†æ— æ³•æœç´¢è¯¥æ–‡ä»¶å¤¹ä¸­çš„å†…å®¹ã€‚</p>
      </a-modal>
    </div>
  </a-config-provider>
</template>

<script setup lang="ts">
import { ref, reactive, computed, onMounted } from 'vue'
import { message } from 'ant-design-vue'
import {
  ArrowLeftOutlined,
  FolderOpenOutlined,
  FolderOutlined,
  PlusOutlined,
  ReloadOutlined,
  DeleteOutlined,
  BarChartOutlined,
  ExportOutlined,
  ClearOutlined,
  FileTextOutlined,
  DatabaseOutlined,
  FileOutlined,
  HardDriveOutlined
} from '@ant-design/icons-vue'

// çŠ¶æ€ç®¡ç†
const showAddModal = ref(false)
const showRebuildModal = ref(false)
const showDeleteModal = ref(false)
const isAddingFolder = ref(false)
const isRebuilding = ref(false)
const isDeleting = ref(false)
const isRebuildingAll = ref(false)

const newFolderPath = ref('')
const rebuildTarget = ref(null)
const deleteTarget = ref(null)

// ç´¢å¼•é€‰é¡¹
const indexOptions = reactive({
  includeSubfolders: true,
  indexContent: true,
  monitorChanges: true
})

// æ–‡ä»¶ç±»å‹è¿‡æ»¤
const fileFilters = reactive({
  documents: true,
  audio: true,
  video: true,
  images: false,
  code: false
})

// å·²ç´¢å¼•æ–‡ä»¶å¤¹æ•°æ®
const indexedFolders = reactive([
  {
    path: 'D:\\Documents',
    fileCount: 1234,
    size: 2345678901,
    lastUpdate: '2å°æ—¶å‰',
    status: 'completed',
    isRebuilding: false,
    isDeleting: false
  },
  {
    path: 'D:\\Projects\\AI',
    fileCount: 567,
    size: 1892345678,
    lastUpdate: '1å¤©å‰',
    status: 'completed',
    isRebuilding: false,
    isDeleting: false
  },
  {
    path: 'E:\\Books\\æŠ€æœ¯',
    fileCount: 2890,
    size: 5678901234,
    lastUpdate: '3å¤©å‰',
    status: 'indexing',
    isRebuilding: false,
    isDeleting: false
  }
])

// ç»Ÿè®¡æ•°æ®
const totalFiles = computed(() => {
  return indexedFolders.reduce((sum, folder) => sum + folder.fileCount, 0)
})

const totalSize = computed(() => {
  return indexedFolders.reduce((sum, folder) => sum + folder.size, 0)
})

const indexSize = ref(234567890)
const indexProgress = ref(85)
const lastUpdateTime = ref('2å°æ—¶å‰')
const supportedFormats = ref('mp4, mp3, txt, md, docx, pdfç­‰')

// æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
const formatSize = (bytes: number) => {
  const units = ['B', 'KB', 'MB', 'GB', 'TB']
  let size = bytes
  let unitIndex = 0

  while (size >= 1024 && unitIndex < units.length - 1) {
    size /= 1024
    unitIndex++
  }

  return `${size.toFixed(1)} ${units[unitIndex]}`
}

// è·å–çŠ¶æ€æ–‡æœ¬
const getStatusText = (status: string) => {
  const statusMap = {
    'completed': 'å·²å®Œæˆ',
    'indexing': 'ç´¢å¼•ä¸­',
    'error': 'é”™è¯¯',
    'paused': 'å·²æš‚åœ'
  }
  return statusMap[status] || status
}

// æ˜¾ç¤ºæ·»åŠ æ–‡ä»¶å¤¹å¼¹çª—
const showAddFolderModal = () => {
  showAddModal.value = true
  newFolderPath.value = ''
}

// é€‰æ‹©æ–‡ä»¶å¤¹
const selectFolder = () => {
  // æ¨¡æ‹Ÿæ–‡ä»¶å¤¹é€‰æ‹©
  newFolderPath.value = 'D:\\Work\\Documents'
}

// ç¡®è®¤æ·»åŠ æ–‡ä»¶å¤¹
const confirmAddFolder = async () => {
  if (!newFolderPath.value.trim()) {
    message.warning('è¯·é€‰æ‹©æ–‡ä»¶å¤¹')
    return
  }

  isAddingFolder.value = true
  try {
    await new Promise(resolve => setTimeout(resolve, 2000))

    indexedFolders.push({
      path: newFolderPath.value,
      fileCount: Math.floor(Math.random() * 1000) + 100,
      size: Math.floor(Math.random() * 1000000000) + 100000000,
      lastUpdate: 'åˆšåˆš',
      status: 'indexing',
      isRebuilding: false,
      isDeleting: false
    })

    showAddModal.value = false
    message.success('æ–‡ä»¶å¤¹æ·»åŠ æˆåŠŸï¼Œå¼€å§‹å»ºç«‹ç´¢å¼•')
  } catch (error) {
    message.error('æ·»åŠ æ–‡ä»¶å¤¹å¤±è´¥')
  } finally {
    isAddingFolder.value = false
  }
}

// å–æ¶ˆæ·»åŠ æ–‡ä»¶å¤¹
const cancelAddFolder = () => {
  showAddModal.value = false
  newFolderPath.value = ''
}

// é‡å»ºç´¢å¼•
const rebuildIndex = (folder: any) => {
  rebuildTarget.value = folder
  showRebuildModal.value = true
}

// ç¡®è®¤é‡å»ºç´¢å¼•
const confirmRebuild = async () => {
  isRebuilding.value = true
  try {
    await new Promise(resolve => setTimeout(resolve, 3000))
    rebuildTarget.value.status = 'completed'
    rebuildTarget.value.lastUpdate = 'åˆšåˆš'
    showRebuildModal.value = false
    message.success('ç´¢å¼•é‡å»ºå®Œæˆ')
  } catch (error) {
    message.error('ç´¢å¼•é‡å»ºå¤±è´¥')
  } finally {
    isRebuilding.value = false
  }
}

// å–æ¶ˆé‡å»ºç´¢å¼•
const cancelRebuild = () => {
  showRebuildModal.value = false
  rebuildTarget.value = null
}

// åˆ é™¤ç´¢å¼•
const deleteIndex = (folder: any) => {
  deleteTarget.value = folder
  showDeleteModal.value = true
}

// ç¡®è®¤åˆ é™¤ç´¢å¼•
const confirmDelete = async () => {
  isDeleting.value = true
  try {
    await new Promise(resolve => setTimeout(resolve, 1500))

    const index = indexedFolders.findIndex(f => f.path === deleteTarget.value.path)
    if (index > -1) {
      indexedFolders.splice(index, 1)
    }

    showDeleteModal.value = false
    message.success('ç´¢å¼•åˆ é™¤æˆåŠŸ')
  } catch (error) {
    message.error('åˆ é™¤ç´¢å¼•å¤±è´¥')
  } finally {
    isDeleting.value = false
  }
}

// å–æ¶ˆåˆ é™¤ç´¢å¼•
const cancelDelete = () => {
  showDeleteModal.value = false
  deleteTarget.value = null
}

// å…¨éƒ¨é‡å»ºç´¢å¼•
const rebuildAllIndexes = async () => {
  isRebuildingAll.value = true
  try {
    await new Promise(resolve => setTimeout(resolve, 5000))
    indexedFolders.forEach(folder => {
      folder.status = 'completed'
      folder.lastUpdate = 'åˆšåˆš'
    })
    message.success('æ‰€æœ‰ç´¢å¼•é‡å»ºå®Œæˆ')
  } catch (error) {
    message.error('é‡å»ºç´¢å¼•å¤±è´¥')
  } finally {
    isRebuildingAll.value = false
  }
}

// æ¸…ç©ºæ‰€æœ‰ç´¢å¼•
const clearAllIndexes = () => {
  if (indexedFolders.length === 0) {
    message.warning('æ²¡æœ‰å¯æ¸…ç©ºçš„ç´¢å¼•')
    return
  }

  // è¿™é‡Œå¯ä»¥æ·»åŠ ç¡®è®¤å¯¹è¯æ¡†
  indexedFolders.splice(0, indexedFolders.length)
  message.success('æ‰€æœ‰ç´¢å¼•å·²æ¸…ç©º')
}

// æ‰“å¼€æ–‡ä»¶å¤¹
const openFolder = (folder: any) => {
  message.info(`æ‰“å¼€æ–‡ä»¶å¤¹: ${folder.path}`)
}

// å¯¼å‡ºç»Ÿè®¡
const exportStats = () => {
  message.success('ç»Ÿè®¡ä¿¡æ¯å¯¼å‡ºå®Œæˆ')
}

// æ¸…ç†ç¼“å­˜
const cleanCache = () => {
  message.success('ç¼“å­˜æ¸…ç†å®Œæˆ')
}

// è¿”å›
const goBack = () => {
  message.info('è¿”å›ä¸Šä¸€é¡µ')
}

// ç»„ä»¶æŒ‚è½½
onMounted(() => {
  // æ¨¡æ‹Ÿç´¢å¼•è¿›åº¦æ›´æ–°
  setInterval(() => {
    if (indexProgress.value < 100) {
      indexProgress.value += Math.random() * 2
      if (indexProgress.value > 100) {
        indexProgress.value = 100
      }
    }
  }, 1000)
})
</script>

<style scoped>
.index-app {
  min-height: 100vh;
  background: #f5f5f5;
}

.layout {
  min-height: 100vh;
}

.header {
  background: #fff;
  padding: 0;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
}

.header-content {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 24px;
  height: 64px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.logo {
  display: flex;
  align-items: center;
  gap: 8px;
}

.logo-icon {
  font-size: 24px;
}

.logo-text {
  font-size: 18px;
  font-weight: 600;
  color: #6366f1;
}

.content {
  padding: 24px;
  background: #f5f5f5;
}

.index-container {
  max-width: 1200px;
  margin: 0 auto;
}

.index-layout {
  display: grid;
  gap: 32px;
}

.section {
  background: #fff;
  border-radius: 12px;
  padding: 24px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 1px solid #f0f0f0;
}

.section-header h2 {
  margin: 0;
  color: #333;
  font-size: 20px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}

.section-actions {
  display: flex;
  gap: 12px;
}

.folder-list {
  display: grid;
  gap: 16px;
}

.folder-card {
  transition: all 0.2s;
}

.folder-card:hover {
  transform: translateY(-2px);
}

.folder-title {
  display: flex;
  align-items: center;
  gap: 8px;
}

.folder-icon {
  font-size: 18px;
}

.folder-path {
  flex: 1;
  font-weight: 500;
}

.status-tag {
  font-size: 12px;
}

.folder-stats {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
  margin-bottom: 16px;
}

.stat-item {
  text-align: center;
  padding: 12px;
  background: #fafafa;
  border-radius: 6px;
}

.stat-label {
  display: block;
  font-size: 12px;
  color: #666;
  margin-bottom: 4px;
}

.stat-value {
  font-size: 14px;
  font-weight: 600;
  color: #333;
}

.empty-state {
  padding: 60px 0;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 32px;
}

.stat-card {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 20px;
  background: #fafafa;
  border-radius: 8px;
  border: 1px solid #f0f0f0;
}

.stat-icon {
  font-size: 24px;
  color: #6366f1;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 48px;
  height: 48px;
  background: #f0f5ff;
  border-radius: 8px;
}

.stat-content {
  flex: 1;
}

.stat-number {
  font-size: 18px;
  font-weight: 600;
  color: #333;
  line-height: 1.2;
}

.stat-label {
  font-size: 12px;
  color: #666;
  margin-top: 4px;
}

.progress-section {
  padding: 24px;
  background: #fafafa;
  border-radius: 8px;
  border: 1px solid #f0f0f0;
}

.progress-section h3 {
  margin: 0 0 16px 0;
  color: #333;
  font-size: 16px;
  font-weight: 600;
}

.progress-info {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 12px;
  font-size: 12px;
  color: #666;
}

.progress-text {
  color: #6366f1;
  font-weight: 500;
}

.folder-selector {
  display: flex;
  gap: 8px;
}

.index-options {
  display: grid;
  gap: 8px;
}

.file-type-filters {
  display: grid;
  gap: 8px;
}

.filter-group {
  padding: 8px 0;
}

:deep(.ant-card-head-title) {
  font-weight: 500;
}

:deep(.ant-card-actions) {
  border-top: 1px solid #f0f0f0;
}

:deep(.ant-card-actions li) {
  margin: 12px 0;
}

:deep(.ant-progress-text) {
  font-weight: 500;
}
</style>